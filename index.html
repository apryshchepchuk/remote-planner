<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Remote planner</title>

<style>
:root{
  /* Corporate palette */
  --bg:#F6F7FB;
  --card:#FFFFFF;
  --text:#0F172A;
  --muted:#64748B;
  --line:#E5E7EB;

  --accent:#2563EB;         /* blue */
  --accent-weak: rgba(37,99,235,.12);

  --ok:#0F766E;             /* teal */
  --ok-weak: rgba(15,118,110,.12);

  --warn:#B45309;           /* amber */
  --warn-weak: rgba(180,83,9,.12);

  --bad:#BE123C;            /* red */
  --bad-weak: rgba(190,18,60,.10);

  --soft:#F3F4F6;
  --soft2:#FAFAFB;

  /* Geometry + motion */
  --r: 16px;
  --r2: 14px;
  --rPill: 999px;
  --gap: 12px;
  --t: 180ms;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(15,23,42,.06);
  --shadow-md: 0 10px 30px rgba(15,23,42,.08);
  --shadow-inset: inset 0 1px 0 rgba(255,255,255,.7);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background:
    radial-gradient(1100px 520px at 15% -10%, rgba(37,99,235,.10), transparent 60%),
    radial-gradient(900px 420px at 92% 0%, rgba(15,118,110,.08), transparent 60%),
    var(--bg);
}

.wrap{ max-width: 1100px; margin: 0 auto; padding: 18px; }

h1{
  font-size: 18px;
  margin: 0 0 10px;
  font-weight: 750;
  letter-spacing: -0.2px;
}

.top{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius: var(--r);
  padding:12px;
  box-shadow: var(--shadow-sm);
}

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.right{ margin-left:auto; }

select, input, button{
  background:#fff;
  color:var(--text);
  border:1px solid var(--line);
  border-radius: var(--r2);
  padding:10px 12px;
  font-size:14px;
  transition: transform var(--t) ease, box-shadow var(--t) ease, border-color var(--t) ease, background var(--t) ease, filter var(--t) ease;
}

button{ cursor:pointer; }
button:hover{
  background: var(--soft2);
  border-color: rgba(37,99,235,.20);
  box-shadow: 0 4px 16px rgba(15,23,42,.06);
  transform: translateY(-1px);
}
button:active{
  transform: translateY(0px);
  box-shadow: none;
}
button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

button.primary{
  background: var(--accent);
  border-color: var(--accent);
  color:#fff;
  box-shadow: 0 6px 18px rgba(37,99,235,.22);
}
button.primary:hover{
  background:#1D4ED8;
  border-color:#1D4ED8;
  filter:none;
}

button.ok{
  background: #0B3A35;
  border-color: rgba(15,118,110,.55);
  color:#E9FFFB;
}
button.ok:hover{ border-color: rgba(15,118,110,.75); }

button.bad{
  background:#3A0B14;
  border-color: rgba(190,18,60,.55);
  color:#FFE7EB;
}
button.bad:hover{ border-color: rgba(190,18,60,.75); }

.tabs{ display:flex; gap:8px; margin-top:12px; }
.tabBtn{
  padding:8px 12px;
  border-radius: var(--rPill);
  border:1px solid var(--line);
  background:#fff;
  font-size:13px;
}
.tabBtn:hover{ border-color: rgba(37,99,235,.25); }
.tabBtn.active{
  background: rgba(37,99,235,.10);
  border-color: rgba(37,99,235,.35);
  color: #1D4ED8;
  font-weight: 700;
}
.tabPane{ display:none; margin-top:12px; }
.tabPane.active{ display:block; }

.badge{
  display:inline-flex;
  gap:6px;
  align-items:center;
  font-size:12px;
  color:var(--muted);
}

.pill{
  display:inline-flex;
  padding:4px 10px;
  border-radius: var(--rPill);
  border:1px solid rgba(229,231,235,.95);
  background: rgba(2,6,23,.04);
  box-shadow: var(--shadow-inset);
}

.tag.vacation{
  background: rgba(37,99,235,.10);
  border-color: rgba(37,99,235,.22);
  color: #1D4ED8;
  font-weight: 700;
}

.fillChip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius: 999px;
  border:1px solid rgba(229,231,235,.95);
  background:#fff;
  font-size:12px;
  font-weight:700;
  color: var(--text);
}
.fillChip.done{
  background: var(--ok-weak);
  border-color: rgba(15,118,110,.25);
  color: #0B3A35;
}
.fillChip.todo{
  background: rgba(2,6,23,.04);
  border-color: rgba(229,231,235,.95);
  color: var(--muted);
}

  
.day.dayoff{
  background: linear-gradient(180deg, #FFFFFF 0%, rgba(37,99,235,.06) 100%);
  border-color: rgba(37,99,235,.25);
}

.remoteMeta{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:auto;
}

.remoteMeta{ justify-content:flex-end; }
.remoteLabel{ max-width: 140px; overflow:hidden; text-overflow:ellipsis; }

.remoteLabel{
  font-size:12px;
  color: var(--muted);
  line-height: 1;
  display:flex;
  gap:6px;
  align-items:center;
  white-space: nowrap;
}

.remoteLabel b{
  color: var(--text);
  font-weight: 850;
  font-size: 13px;   
}

.hr{ height:1px; background: rgba(229,231,235,.9); margin:10px 0; }
.muted{ color:var(--muted); font-size:13px; }
.small{ font-size:12px; }

@media (max-width: 980px){
  .split2{ grid-template-columns: 1fr; }
}

.grid{
  display:grid;
  grid-template-columns: repeat(5, 1fr);
  gap:12px;
}

/* Calendar cards */
.day{
  padding:12px;
  border-radius: var(--r);
  border:1px solid rgba(229,231,235,.95);
  background:
    linear-gradient(180deg, #FFFFFF 0%, #FBFBFD 100%);
  min-height:150px;
  box-shadow: var(--shadow-sm);
  transition: transform var(--t) ease, box-shadow var(--t) ease, border-color var(--t) ease;
}
.day:hover{
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: rgba(37,99,235,.22);
}

.day .topline{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
.day .date{ font-weight:800; letter-spacing:-0.2px; }
.day .controls{ display:flex; gap:8px; margin-top:10px; }

.slots{
  margin-top: 8px;
  display:flex;
  flex-direction:column;
  gap:6px;  
}

.slot .who b{
  font-size: 14px;
  font-weight: 700;
}

.slot{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;

  padding:6px 4px;         
  background: transparent;  
  border: none;          
  box-shadow: none;      
  transition: none;
}
.day:hover .slot{
  border-color: rgba(229,231,235,.95);
}
.slot .who{ display:flex; flex-direction:column; line-height:1.15; }
.slot .who b{ font-size:13px; }
.slot .who span{ font-size:12px; color:var(--muted); }

/* Tags */
.tag{
  font-size:12px;
  padding:4px 10px;
  border-radius: var(--rPill);
  border:1px solid rgba(229,231,235,.95);
  background:#fff;
  box-shadow: var(--shadow-inset);
}

.tag{
  font-weight: 700;
  letter-spacing: .1px;
}

.tag.remote{
  background: #ECFEFF;              
  border-color: #22D3EE;          
  color: #0369A1;              
  font-weight: 700;
}

.tag.office{
  background: #F1F5F9;            
  border-color: #CBD5E1;          
  color: #334155;               
  font-weight: 600;
}

.tag.pending{
  background: var(--warn-weak);
  border-color: rgba(180,83,9,.25);
  color: #92400e;
  font-weight: 700;
}
.tag.lock{
  background: rgba(180,83,9,.10);
  border-color: rgba(180,83,9,.25);
  color: var(--warn);
  font-weight: 700;
}

.tag.remote{
  box-shadow: 0 0 0 1px rgba(34,211,238,.35);
}

.tag.office{
  box-shadow: inset 0 0 0 1px rgba(203,213,225,.6);
}

.tag.vacation{ box-shadow: 0 0 0 1px rgba(37,99,235,.18); }

/* Day states */
.day.has-pending{
  background: linear-gradient(180deg, #FFFFFF 0%, rgba(180,83,9,.06) 100%);
  border-color: rgba(180,83,9,.28);
}
.day.remote-full{
  background: linear-gradient(180deg, #FFFFFF 0%, rgba(15,118,110,.06) 100%);
  border-color: rgba(15,118,110,.25);
}
.day.remote-full .pill{
  background: rgba(15,118,110,.10);
  border-color: rgba(15,118,110,.22);
  color: #0B3A35;
}

.day.remote-full:hover{
  box-shadow: 0 0 0 4px rgba(15,118,110,.10), var(--shadow-md);
}

/* === Birthday highlight === */
.day.birthday{
  border: 2px solid rgba(245,158,11,.75);
  box-shadow: 0 0 0 4px rgba(245,158,11,.10), var(--shadow-sm);
  background: linear-gradient(180deg, #FFFFFF 0%, rgba(245,158,11,.08) 100%);
}

.bdayPill{
  background: rgba(245,158,11,.12) !important;
  border-color: rgba(245,158,11,.35) !important;
  color: #92400e !important;
  font-weight: 800;
}
  
 .bdayPill{
  white-space: nowrap;
  padding: 2px 8px;
} 
/* Personal warnings / small callouts */
.pill.my-remote.warn{
  background: rgba(180,83,9,.10);
  border-color: rgba(180,83,9,.25);
  color:#92400e;
}


/* Modal */
.modalBackdrop{
  position:fixed;
  inset:0;
  background: rgba(15,23,42,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.modal{
  width:min(720px, 100%);
}

@keyframes pop{
  from { transform: translateY(10px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}


.choices{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.choiceBtn{ min-width: 160px; }

/* –ø—Ä–∏–±–∏—Ä–∞—î–º–æ ‚Äú—Ä–∞–º–∫—É/–ø–ª–∞—à–∫—É‚Äù –Ω–∞–≤–∫–æ–ª–æ —Ç–∏–∂–Ω—è */
#nextWeekCard.card,
#thisWeekCard.card{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* —â–æ–± –≤–∫–ª–∞–¥–∫–∞ —Ç–µ–∂ –Ω–µ –¥–∞–≤–∞–ª–∞ –∑–∞–π–≤–∏–π –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É */
.tabPane .card{
  margin-top: 0;
}

/* –ì—Ä—ñ–¥: –∫–æ–ª–æ–Ω–∫–∏ —Ä—ñ–≤–Ω—ñ, –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç—è–≥–Ω—É—Ç—å—Å—è */
.grid{
  align-items: stretch;
}

.grid{
  align-items: stretch;
  grid-auto-rows: 1fr;     /* –∫–ª—é—á: —É—Å—ñ –∫–æ–ª–æ–Ω–∫–∏ –æ–¥–Ω–∞–∫–æ–≤–æ—ó –≤–∏—Å–æ—Ç–∏ */
}

.day{
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;           /* –≤–∞–∂–ª–∏–≤–æ, —â–æ–± flex –Ω–µ ‚Äú—É–ø–∏—Ä–∞–≤—Å—è‚Äù */
}

/* –°–ª–æ—Ç–∏ –∑–∞–π–º–∞—é—Ç—å –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä */
.day .slots{
  flex: 1 1 auto;
  min-height: 0;
}

/* –ö–Ω–æ–ø–∫–∏ –∑–∞–≤–∂–¥–∏ –∑–Ω–∏–∑—É */
.day .controls{
  margin-top: auto;
}

/* –©–æ–± ‚Äú–í–∏—Ö—ñ–¥–Ω–∏–π‚Äù/—ñ–Ω—à—ñ —Ç–µ–≥–∏ –Ω–µ —Ä–æ–∑–¥—É–≤–∞–ª–∏ –≤–µ—Ä—Ö */
.day .topline{
  min-height: 28px; /* –º–æ–∂–Ω–∞ 26-32 */
}

/* (–æ–ø—Ü—ñ–π–Ω–æ) –æ–¥–Ω–∞–∫–æ–≤–∞ –≤–∏—Å–æ—Ç–∞ —Ä—è–¥–∫–∞ "slot" */
.slot{
  min-height: 52px; /* –ø—ñ–¥–≥–æ–Ω–∏ –ø—ñ–¥ —Å–≤—ñ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
}

.remoteMeta { white-space: nowrap; }
.remoteLabel { white-space: nowrap; }

/* --- FIX v2: 3 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ + –Ω–∞–∑–≤–∏ –≤–∏–¥–Ω–æ --- */
.day .controls{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  margin-top: auto;
}

.day .controls button{
  min-width: 0;
  padding: 10px 8px;
  font-size: 13px;
  border-radius: 14px;

  /* –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –æ–±—Ä—ñ–∑–∞–Ω–Ω—è –¥–æ "..." */
  overflow: hidden;
  text-overflow: initial;
  white-space: normal;

  /* –ø–æ–∫–∞–∑—É—î–º–æ –¥–æ 2 —Ä—è–¥–∫—ñ–≤ —ñ –Ω–µ –¥–∞—î–º–æ —Ä–æ–∑–¥—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;

  line-height: 1.1;
  height: 48px;       /* —Ñ—ñ–∫—Å –≤–∏—Å–æ—Ç–∏ –∫–Ω–æ–ø–∫–∏ => –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —Ä–æ—Å—Ç—É—Ç—å */
}

.day .topline{
  min-height: 36px;
  align-items: center;
}
.remoteMeta{
  white-space: nowrap;
}

/* 1) –ì—Ä—ñ–¥ –ù–ï –¥–∞—î –∫–æ–ª–æ–Ω–∫–∞–º —Ä–æ–∑–¥—É–≤–∞—Ç–∏—Å—è –≤—ñ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç—É */
.grid{
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr)); /* –∫–ª—é—á–æ–≤–∞ –∑–º—ñ–Ω–∞ */
  gap: 12px;
  align-items: stretch;
}

/* 2) –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–Ω—è –º–æ–∂–µ —Å—Ç–∏—Å–∫–∞—Ç–∏—Å—è */
.day{
  min-width: 0;           /* –∫–ª—é—á–æ–≤–∞ –∑–º—ñ–Ω–∞ */
  display: flex;
  flex-direction: column;
}

/* 3) –°–ª–æ—Ç–∏ –∑–∞–π–º–∞—é—Ç—å –ø—Ä–æ—Å—Ç—ñ—Ä, –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏—Ç–∏—Å–Ω—É—Ç—ñ –≤–Ω–∏–∑ */
.day .slots{
  flex: 1 1 auto;
  min-height: 0;
}
.day .controls{
  margin-top: auto;
}

/* 4) –ö–Ω–æ–ø–∫–∏ Remote/Office/–í—ñ–¥–ø—É—Å—Ç–∫–∞ ‚Äî 3 —Ä—ñ–≤–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏ —ñ –Ω–µ ‚Äú–ª–∞–º–∞—é—Ç—å‚Äù —à–∏—Ä–∏–Ω—É */
.day .controls{
  display: grid;                                 /* –∫–ª—é—á–æ–≤–∞ –∑–º—ñ–Ω–∞ */
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
}

.day .controls button{
  min-width: 0;
  width: 100%;
  white-space: nowrap;
  overflow: visible;       /* —â–æ–± –Ω–µ –±—É–ª–æ ‚ÄúR...‚Äù */
  text-overflow: clip;
}

/* 5) –®–∞–ø–∫–∞ –¥–Ω—è: –Ω–µ –¥–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∞–º —Ç—è–≥–Ω—É—Ç–∏ —à–∏—Ä–∏–Ω—É */
.day .topline{
  min-width: 0;
}
.remoteMeta{
  min-width: 0;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 8px;
}
.remoteLabel{
  min-width: 0;
  max-width: 170px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* 6) –ö–Ω–æ–ø–∫–∞ "–í–∏—Ö—ñ–¥–Ω–∏–π/–°–∫–∞—Å—É–≤–∞—Ç–∏" —É –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞ ‚Äî —Ç—ñ–ª—å–∫–∏ —ñ–∫–æ–Ω–∫–∞ (–Ω–µ –≤–∏–∂–∏—Ä–∞—î —à–∏—Ä–∏–Ω—É) */
.dayActionBtn{
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 999px;
  line-height: 1;
  white-space: nowrap;
}
.dayActionBtn span{ display:none; } /* —Ö–æ–≤–∞—î–º–æ —Ç–µ–∫—Å—Ç, –ª–∏—à–∞—î–º–æ title */

/* –ö–Ω–æ–ø–∫–∏-–∫–æ–Ω—Ç—Ä–æ–ª–∏: —Ç—ñ–ª—å–∫–∏ —ñ–∫–æ–Ω–∫–∏ */
.controls .iconBtn{
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 14px 10px;     /* –±—ñ–ª—å—à–µ ‚Äú–ø–æ–≤—ñ—Ç—Ä—è‚Äù */
}

.controls .iconBtn .btnText{
  display: none;          /* —Ö–æ–≤–∞—î–º–æ –ø—ñ–¥–ø–∏—Å */
}

.controls .iconBtn .btnIcon{
  font-size: 22px;        /* –∑–±—ñ–ª—å—à—É—î–º–æ —ñ–∫–æ–Ω–∫—É */
  line-height: 1;
}

/* —â–æ–± –∫–Ω–æ–ø–∫–∏ –Ω–µ ‚Äú–ø—Ä–æ–¥–∞–≤–ª—é–≤–∞–ª–∏‚Äù —à–∏—Ä–∏–Ω—É */
.controls .iconBtn{
  min-width: 0;
  width: 100%;
  white-space: nowrap;
}

.slotOverrideNote{
  font-size:11px;
  color: var(--muted);
  margin-top: 2px;
}

/* Manager: show status + override buttons */
.slotRight{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 0;
}

.mgrOverrideBtns{
  display:flex;
  gap:6px;
}

.mgrOverrideBtns .iconBtn{
  border:1px solid rgba(229,231,235,.95);
  border-radius: 999px;
  padding: 8px 10px;
  line-height: 1;
  background:#fff;
  cursor:pointer;
}

.mgrOverrideBtns .iconBtn:hover{
  background: var(--soft2);
}

.slotOverrideNote{
  margin-top:4px;
  font-size:11px;
  color: var(--warn);
}

/* Ultra-compact edit icon (manager) */
.mgrEditBtn{
  all: unset;                 /* —Å–∫–∏–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É */
  cursor: pointer;
  font-size: 14px;            /* –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –æ–ª—ñ–≤–µ—Ü—å */
  line-height: 1;
  opacity: .55;
  flex: 0 0 auto;
  padding: 2px;
}

.mgrEditBtn:hover{
  opacity: 1;
  transform: scale(1.05);
}
.slotRight{
  display:flex;
  align-items:center;
  gap:8px;
  min-width: 0;
  position: relative; /* –¥–ª—è –ø–æ–ø–æ–≤–µ—Ä–∞ */
}

/* pill –Ω–µ —Å—Ç–∏—Å–∫–∞—î–º–æ –ø–æ —à–∏—Ä–∏–Ω—ñ */
.slotRight .tag{ flex: 0 0 auto; }

.slotRight{
  display:flex;
  align-items:center;
  gap:6px;          /* –º–µ–Ω—à–µ –ø–æ–≤—ñ—Ç—Ä—è */
  min-width: 0;
  position: relative;
}

/* popover */
.mgrPopover{
  position:absolute;
  right:0;
  top: calc(100% + 6px);
  z-index: 50;
  background: #fff;
  border: 1px solid rgba(229,231,235,.95);
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(15,23,42,.12);
  padding: 8px;
  display:none;
  white-space: nowrap;
}

.mgrPopover.open{ display:flex; gap:6px; }

.mgrPopover .iconBtn{
  border:1px solid rgba(229,231,235,.95);
  border-radius: 999px;
  padding: 8px 10px;
  line-height: 1;
  background:#fff;
  cursor:pointer;
}
.mgrPopover .iconBtn:hover{ background: var(--soft2); }

.slot .mgrEditBtn{
  opacity: 0;
}

.slot:hover .mgrEditBtn{
  opacity: .6;
}

.slot:hover .mgrEditBtn:hover{
  opacity: 1;
}

.onlyEmployee.hidden { display: none !important; }

/* === UI tweak: –ø—Ä–∏–±—Ä–∞—Ç–∏ –≤–µ—Ä—Ö–Ω—ñ–π –±—ñ–ª–∏–π –±–ª–æ–∫ authCard === */
#authCard.card{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* —â–æ–± –µ–ª–µ–º–µ–Ω—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω–µ ‚Äú–ª–∏–ø–ª–∏‚Äù –¥–æ –∫—Ä–∞—ó–≤ */
#authCard .row{
  padding: 0 !important;
}

/* –æ–ø—Ü—ñ–π–Ω–æ: –≤–∏—Ä—ñ–≤–Ω—è—Ç–∏ –∫–Ω–æ–ø–∫—É Logout —ñ —Å—Ç–∞—Ç—É—Å —Ç—Ä–æ—Ö–∏ –∞–∫—É—Ä–∞—Ç–Ω—ñ—à–µ */
#btnLogout{
  margin-left: auto;
}
#authStatus{
  margin-left: auto;
  padding-right: 10px;
}

/* Mobile: calendar scroll instead of squeezing */
.weekScroller{
  width: 100%;
}

@media (max-width: 720px){
  .weekScroller{
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px; /* —â–æ–± –±—É–ª–æ –∑—Ä—É—á–Ω–æ —Å–∫—Ä–æ–ª–∏—Ç–∏ */
  }

  /* –≥—Ä—ñ–¥ –Ω–µ —Å—Ç–∏—Å–∫–∞—î–º–æ ‚Äî —Ö–∞–π –º–∞—î –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É —à–∏—Ä–∏–Ω—É */
  .weekScroller .grid{
    min-width: 980px; /* –ø—ñ–¥—ñ–≥–Ω–∞—Ç–∏: 900‚Äì1100 */
  }

  /* –ø–ª–∞—à–∫–∏ –Ω–µ –ø–æ–≤–∏–Ω–Ω—ñ –≤–∏–ª–∞–∑–∏—Ç–∏ –∑–∞ –º–µ–∂—ñ */
  .slot, .slotRight, .tag{
    max-width: 100%;
  }
}

/* === Fill button UX: –Ω–µ –≤–∏–≥–ª—è–¥–∞—î "–≤–∂–µ –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ—é" === */
#btnToggleFilled{
  position: relative;
  font-weight: 800;
}

/* –°—Ç–∞–Ω: —Ç—Ä–µ–±–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ (–ø—ñ—Å–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è) */
#btnToggleFilled.fillTodo{
  background: #fff !important;
  color: var(--accent) !important;
  border-color: rgba(37,99,235,.45) !important;
  box-shadow: 0 0 0 4px rgba(37,99,235,.10);
}

/* –ª–µ–≥–∫–∏–π ‚Äúcall-to-action‚Äù –Ω–∞ hover */
#btnToggleFilled.fillTodo:hover{
  background: rgba(37,99,235,.06) !important;
  border-color: rgba(37,99,235,.60) !important;
  box-shadow: 0 0 0 6px rgba(37,99,235,.14), 0 10px 24px rgba(15,23,42,.10);
}

/* –ø—ñ–¥–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ (–Ω–µ–Ω–∞–≤‚Äô—è–∑–ª–∏–≤–æ) */
#btnToggleFilled.fillTodo::after{
  content: "–ù–∞—Ç–∏—Å–Ω–∏ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –¥–Ω—ñ–≤";
  position: absolute;
  left: 50%;
  bottom: -26px;
  transform: translateX(-50%);
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(37,99,235,.25);
  background: #fff;
  color: var(--muted);
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  box-shadow: 0 10px 24px rgba(15,23,42,.08);
  transition: opacity var(--t) ease, transform var(--t) ease;
}

#btnToggleFilled.fillTodo:hover::after{
  opacity: 1;
  transform: translateX(-50%) translateY(-2px);
}

/* –°—Ç–∞–Ω: –≤–∂–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ (–∫–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä = ‚Äú—Å–∫–∞—Å—É–≤–∞—Ç–∏‚Äù) */
#btnToggleFilled.fillDone{
  background: rgba(2,6,23,.04) !important;
  color: var(--muted) !important;
  border-color: rgba(229,231,235,.95) !important;
  box-shadow: none !important;
}

#btnToggleFilled.fillDone:hover{
  background: rgba(190,18,60,.06) !important;
  border-color: rgba(190,18,60,.22) !important;
  color: #7F1D1D !important;
}

  /* === Manager YTD stats === */
#mgrStatsBody{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.statRow{
  display:grid;
  grid-template-columns: 180px 1fr 64px 64px 64px 120px; /* R, O, V, R/O */
  gap:10px;
  align-items:center;
}

@media (max-width: 720px){
  .statRow{
    grid-template-columns: 1fr;
    gap:6px;
  }
}

.statName{
  font-weight:750;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.statBars{
  display:flex;
  gap:10px;
  align-items:center;
}

.barTrack{
  position:relative;
  flex:1 1 auto;
  height:10px;
  border-radius: 999px;
  background: rgba(2,6,23,.06);
  overflow:hidden;
}

.barFill{
  position:absolute;
  left:0; top:0; bottom:0;
  width:0%;
  border-radius:999px;
}

.barFill.remote{ background: rgba(37,99,235,.55); }
.barFill.vacation{ background: rgba(15,118,110,.55); }
.barFill.office{ background: rgba(51,65,85,.45); }

.statNum{
  text-align:right;
  font-weight:800;
  font-size:12px;
  color: var(--text);
}
.statNum span{
  color: var(--muted);
  font-weight:700;
  margin-left:6px;
}

/* === Fill chips: —Ç—ñ–ª—å–∫–∏ —ñ–∫–æ–Ω–∫–∞ + —ñ–º'—è (–±–µ–∑ –±–µ–π–¥–∂-—Ñ–æ–Ω—É) === */
#filledChips .fillChip{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;

  padding: 0 !important;
  border-radius: 0 !important;

  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* –¢—Ä–æ—Ö–∏ ‚Äú–ø—ñ–¥–∫–∞–∑—É—î–º–æ‚Äù —Å—Ç–∞–Ω –±–µ–∑ —Ñ–æ–Ω—É */
#filledChips .fillChip.todo{
  color: var(--muted);
  opacity: .8;
}
#filledChips .fillChip.done{
  color: var(--text);
  font-weight: 700;
}

/* === Toast (local, no-AI) === */
.toastHost{
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.toast{
  pointer-events: auto;
  width: min(760px, calc(100vw - 28px));
  background: #fff;
  border: 1px solid rgba(229,231,235,.95);
  border-radius: 16px;
  box-shadow: 0 14px 34px rgba(15,23,42,.18);
  padding: 12px 14px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  animation: toastIn 180ms ease both;
}

.toast .tIcon{
  font-size: 18px;
  line-height: 1;
  margin-top: 2px;
}
.toast .tBody{ flex: 1 1 auto; min-width: 0; }
.toast .tTitle{
  font-weight: 850;
  font-size: 13px;
  margin: 0 0 3px;
}
.toast .tMsg{
  color: var(--muted);
  font-size: 13px;
  line-height: 1.35;
  margin: 0;
}
.toast .tClose{
  all: unset;
  cursor: pointer;
  font-size: 16px;
  opacity: .55;
  padding: 2px 4px;
}
.toast .tClose:hover{ opacity: 1; }

.toast.remote{ border-color: rgba(34,211,238,.45); }
.toast.vacation{ border-color: rgba(37,99,235,.35); }

@keyframes toastIn{
  from { transform: translateY(10px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
@keyframes toastOut{
  from { transform: translateY(0); opacity: 1; }
  to   { transform: translateY(10px); opacity: 0; }
}
/* Icon-only mail button (no frame, no text) */
.mailIconBtn{
  all: unset;               /* –∑–Ω—ñ–º–∞—î —Ä–∞–º–∫–∏/—Ñ–æ–Ω/–ø–∞–¥—ñ–Ω–≥–∏, –∞–ª–µ –∑–±–µ—Ä—ñ–≥–∞—î button –ø–æ–≤–µ–¥—ñ–Ω–∫—É */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;

  font-size: 18px;          /* —Ä–æ–∑–º—ñ—Ä —ñ–∫–æ–Ω–∫–∏ */
  line-height: 1;
  padding: 6px;             /* –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–∞ –∑–æ–Ω–∞ */
  border-radius: 999px;

  opacity: .75;
  transition: transform var(--t) ease, opacity var(--t) ease, background var(--t) ease;
}

.mailIconBtn:hover{
  opacity: 1;
  transform: translateY(-1px);
  background: rgba(2,6,23,.04);   /* –ª–µ–≥–∫–∏–π —Ö–æ–≤–µ—Ä –±–µ–∑ —Ä–∞–º–∫–∏ */
}

.mailIconBtn:active{
  transform: translateY(0);
  background: rgba(2,6,23,.06);
}

.mailIconBtn:focus-visible{
  outline: 2px solid rgba(37,99,235,.35);
  outline-offset: 2px;
}
  
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h1>–ì—Ä–∞—Ñ—ñ–∫ –æ—Ñ—ñ—Å/remote</h1>
  </div>
  
<div class="card" id="authCard">
  <div class="row" style="width:100%;">
    <div id="loginFields" class="row" style="gap:10px; flex-wrap:wrap;">
      <input id="loginEmail" type="email" placeholder="Email" />
      <input id="loginPass" type="password" placeholder="Password" />
      <button id="btnLogin" class="primary">Login</button>
      <button id="btnForgot" type="button">–ó–∞–±—É–≤ –ø–∞—Ä–æ–ª—å</button>
    </div>
    <span class="right"></span>
    <!-- —Å—Ç–∞—Ç—É—Å –º–∞—î –±—É—Ç–∏ –≤–∏–¥–∏–º–∏–π –∑–∞–≤–∂–¥–∏ -->
    <span class="muted small" id="authStatus">Not logged in</span>

    <!-- Logout —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ª–æ–≥—ñ–Ω—É -->
    <button id="btnLogout" class="bad" style="display:none;">Logout</button>
  </div>
</div>
  <div class="card" id="resetCard" style="display:none; margin-top:12px;">
  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <b>–ó–∞–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</b>
    <span class="right"></span>
  </div>
  <div class="hr"></div>
  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <input id="newPass1" type="password" placeholder="–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å" />
    <input id="newPass2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª—å" />
    <button id="btnSetNewPass" class="primary" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
    <button id="btnCancelReset" type="button">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
  <div class="muted small" style="margin-top:8px;">
    –¶–µ–π –±–ª–æ–∫ –∑ º—è–≤–ª—è—î—Ç—å—Å—è –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –∑ –ª–∏—Å—Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—é.
  </div>
</div>

  <div id="afterLogin" style="display:none;">
  <div class="card">
    <div class="row">
      <label class="badge">–Ø:</label>
      <select id="me" style="display:none"></select>

      <span id="meName" class="pill" style="display:none;"></span>

<span class="badge onlyEmployee">–ú–æ—ó –≤—ñ–¥–¥–∞–ª–µ–Ω—ñ –¥–Ω—ñ:</span>
<span id="myRemoteCount" class="pill my-remote onlyEmployee"></span>

<span class="badge onlyEmployee">–ú–æ—ó —Ç–æ–∫–µ–Ω–∏:</span>
<span id="myTokens" class="pill onlyEmployee"></span>
<button id="btnReset" class="bad" style="display:none">–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ (local)</button>
      <span id="mgrControls" class="row" style="gap:8px;"></span>
      <!-- Manager: YTD stats -->
<div id="mgrStatsCard" class="card" style="display:none; margin-top:12px;">
  <div class="row" style="width:100%; align-items:center;">
    <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Ä—ñ–∫</b>
    <span class="right"></span>
    <span id="mgrStatsHint" class="muted small"></span>
    <button id="btnMgrStatsToggle" type="button">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</button>
    <button id="btnMgrStatsRefresh" type="button">–û–Ω–æ–≤–∏—Ç–∏</button>
  </div>

  <!-- ‚¨áÔ∏è –í–ï–°–¨ –ö–û–ù–¢–ï–ù–¢ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ö–æ–≤–∞—î–º–æ/–ø–æ–∫–∞–∑—É—î–º–æ -->
  <div id="mgrStatsContent" style="display:none;">
    <div class="hr"></div>

    <div id="mgrStatsBody"></div>

  </div>
</div>
    <div class="hr"></div>
  <div class="row" id="weekFillBar" style="gap:8px; flex-wrap:wrap; align-items:center;">
    <span class="badge">–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞:</span>
    <div id="filledChips" class="row" style="gap:6px; flex-wrap:wrap;"></div>
    <span class="right"></span>

    <!-- —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ -->
    <button id="btnToggleFilled" class="primary onlyEmployee" type="button">–Ø –∑–∞–ø–æ–≤–Ω–∏–≤</button>
  </div>

  <div style="height:12px"></div>

<div class="tabs">
  <button class="tabBtn" id="tabNext">–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å (–ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è)</button>
  <button class="tabBtn" id="tabThis">–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å (–ø–µ—Ä–µ–≥–ª—è–¥)</button>
</div>
  
<div id="paneNext" class="tabPane">
  <div class="card" id="nextWeekCard"></div>
</div>

<div id="paneThis" class="tabPane">
  <div class="card" id="thisWeekCard"></div>
</div>

</div><!-- /afterLogin -->
<!-- Modal: conflict resolver -->
<div id="modalBackdrop" class="modalBackdrop">
  <div class="card modal">
    <div class="row">
      <b id="modalTitle">–ö–æ–Ω—Ñ–ª—ñ–∫—Ç –∑–∞ remote</b>
      <span class="right"></span>
      <button id="modalClose">‚úï</button>
    </div>
    <div class="hr"></div>
    <div id="modalBody" class="muted"></div>
    <div class="choices">
      <button id="btnUseToken" class="choiceBtn primary">üéüÔ∏è Use token</button>
      <button id="btnFairRoll" class="choiceBtn">‚öñÔ∏è Fairness roll</button>
    </div>
    <div class="hr"></div>
    <div class="muted small">–¢–æ–∫–µ–Ω–∏ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è —â–æ–º—ñ—Å—è—Ü—è (1 –Ω–∞ –ª—é–¥–∏–Ω—É). Fairness roll –ø—ñ–¥—Å–∏–ª—é—î —Ç–æ–≥–æ, —Ö—Ç–æ —á–∞—Å—Ç—ñ—à–µ –ø—Ä–æ–≥—Ä–∞–≤–∞–≤ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏.</div>
  </div>
</div>
    <!-- Toast host -->
<div id="toastHost" class="toastHost" aria-live="polite" aria-atomic="true"></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<script>
const SUPABASE_URL = "https://gwpmbzkuvkamitvtvjiy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3cG1iemt1dmthbWl0dnR2aml5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODE1MDgsImV4cCI6MjA4MjA1NzUwOH0.6vgbAK0nIj3FqaX39FgQatNtj4EYecXf9fUl2RxExbo";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  }
});
  
let currentSession = null;
let isRecoveryMode = false;

function detectRecoveryFromUrl(){
  const h = new URLSearchParams((location.hash || "").replace(/^#/, ""));
  const q = new URLSearchParams(location.search || "");
  return h.get("type") === "recovery" || q.get("type") === "recovery";
}

// —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑ recovery-–ª—ñ–Ω–∫–∞
isRecoveryMode = detectRecoveryFromUrl();

 // ===== Week "filled" tracking (planner_submissions) =====
const SUBMISSIONS_TABLE = "planner_submissions";
let nextWeekSubmissions = {}; // { [userId]: submitted_at_iso }

function isEmployee(u){ return u && u.role !== "manager"; }

function allEmployeesIds(){
  return TEAM.filter(isEmployee).map(u => u.id);
}

function mySubmitted(){
  const me = currentUser();
  if(!me) return false;
  return !!nextWeekSubmissions[me.id];
}

async function loadNextWeekSubmissions(){
  if(!isLoggedIn()) return;

  const { data, error } = await sb
    .from(SUBMISSIONS_TABLE)
    .select("user_id,submitted_at")
    .eq("week_start", nextWeekStart);

  if(error){
    console.warn("loadNextWeekSubmissions error:", error);
    nextWeekSubmissions = {};
    return;
  }

  nextWeekSubmissions = {};
  (data || []).forEach(r => { nextWeekSubmissions[r.user_id] = r.submitted_at; });
}

async function toggleMySubmission(){
  const me = currentUser();
  if(!me || me.role === "manager") return;

  if(mySubmitted()){
    // unmark
    const { error } = await sb
      .from(SUBMISSIONS_TABLE)
      .delete()
      .eq("week_start", nextWeekStart)
      .eq("user_id", me.id);

    if(error){
      console.error("unsubmit error:", error);
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–∞—Å—É–≤–∞—Ç–∏ –ø–æ–∑–Ω–∞—á–∫—É. –î–∏–≤–∏—Å—å Console.");
      return;
    }
  }else{
    // mark
    const { error } = await sb
      .from(SUBMISSIONS_TABLE)
      .insert({ week_start: nextWeekStart, user_id: me.id });

    if(error){
      console.error("submit error:", error);
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ–∑–Ω–∞—á–∫—É. –î–∏–≤–∏—Å—å Console.");
      return;
    }
  }

  // UI —à–≤–∏–¥–∫–æ –æ–Ω–æ–≤–∏–º–æ (realtime —Ç–µ–∂ –ø—ñ–¥—Ç—è–≥–Ω–µ)
  await loadNextWeekSubmissions();
  render();
}

function renderFillBar(){
  const bar = document.getElementById("weekFillBar");
  if(!bar) return;

  const chips = document.getElementById("filledChips");
  const count = document.getElementById("filledCount");
  const btn = document.getElementById("btnToggleFilled");

  if(!isLoggedIn() || !TEAM.length){
    if(count) count.textContent = "‚Äî";
    if(chips) chips.innerHTML = "";
    if(btn) btn.style.display = "none";
    return;
  }

  const emps = TEAM.filter(isEmployee);
  const done = emps.filter(u => !!nextWeekSubmissions[u.id]).length;

  if(count) count.textContent = `${done}/${emps.length}`;

  if(chips){
    chips.innerHTML = emps.map(u => {
      const ok = !!nextWeekSubmissions[u.id];
      return `<span class="fillChip ${ok ? "done" : "todo"}">${ok ? "‚úÖ" : "‚è≥"} ${escapeHtml(u.name)}</span>`;
    }).join("");
  }

  const me = currentUser();
  if(btn){
    if(me?.role === "manager"){
      btn.style.display = "none";
    }else{
      btn.style.display = "";
      btn.textContent = mySubmitted() ? "‚Ü©Ô∏è –°–∫–∞—Å—É–≤–∞—Ç–∏ (—â–µ –ø—Ä–∞–≤–ª—é)" : "üìù –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è";
      btn.classList.toggle("fillDone", mySubmitted());
btn.classList.toggle("fillTodo", !mySubmitted());
    }
  }
}

  
/** =============================
 * Auth bootstrap: catch INITIAL_SESSION early (page refresh)
 * ============================= */
let __initialSessionResolved = false;
let __initialSessionResolve;
const __initialSessionPromise = new Promise(res => (__initialSessionResolve = res));

// Register early to avoid missing INITIAL_SESSION when the page loads fast
sb.auth.onAuthStateChange((event, session) => {
  if(event === "INITIAL_SESSION" && !__initialSessionResolved){
    __initialSessionResolved = true;
    __initialSessionResolve(session || null);
  }
});

// ===== Password reset UI helpers =====
const resetCard = document.getElementById("resetCard");
const btnForgot = document.getElementById("btnForgot");
const btnSetNewPass = document.getElementById("btnSetNewPass");
const btnCancelReset = document.getElementById("btnCancelReset");

function showResetCard(show){
  if(!resetCard) return;
  resetCard.style.display = show ? "block" : "none";
}

// 1) Step 1: send password recovery email
if(btnForgot){
  btnForgot.addEventListener("click", async () => {
    const emailEl = document.getElementById("loginEmail");
    const email = (emailEl?.value || "").trim() || prompt("–í–∫–∞–∂–∏ email –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—é:", "");
    if(!email) return;

    // redirect back to THIS page
    const redirectTo = window.location.origin + window.location.pathname;

    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    // –í–∞–∂–ª–∏–≤–æ: –Ω–µ –ø–∞–ª–∏–º–æ, —á–∏ —ñ—Å–Ω—É—î email ‚Äî –æ–¥–Ω–∞–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    if(error){
      console.error("resetPasswordForEmail error:", error);
      alert("–Ø–∫—â–æ email —ñ—Å–Ω—É—î ‚Äî —Ç–∏ –æ—Ç—Ä–∏–º–∞—î—à –ª–∏—Å—Ç –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—é. –ü–µ—Ä–µ–≤—ñ—Ä –ø–æ—à—Ç—É.");
      return;
    }
    alert("–Ø–∫—â–æ email —ñ—Å–Ω—É—î ‚Äî —Ç–∏ –æ—Ç—Ä–∏–º–∞—î—à –ª–∏—Å—Ç –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—é. –ü–µ—Ä–µ–≤—ñ—Ä –ø–æ—à—Ç—É.");
  });
}

// 2) Step 2: when user comes back via recovery link -> show UI and update password
if(btnCancelReset){
  btnCancelReset.addEventListener("click", async () => {
    // –≤–∏–π—Ç–∏ –∑ recovery —Ä–µ–∂–∏–º—É
    isRecoveryMode = false;
    showResetCard(false);

    try { await sb.auth.signOut({ scope:"local" }); } catch(e) {}
    try { forceClearSupabaseAuth(); } catch(e) {}

    // –ø—Ä–∏–±—Ä–∞—Ç–∏ hash/query –≤—ñ–¥ recovery
    try { history.replaceState({}, document.title, window.location.pathname); } catch(e) {}

    currentSession = null;
    setAuthUI(null);
    try { render(); } catch(e) {}
  });
}

if(btnSetNewPass){
  btnSetNewPass.addEventListener("click", async () => {
    const p1 = (document.getElementById("newPass1")?.value || "");
    const p2 = (document.getElementById("newPass2")?.value || "");

    if(p1.length < 8) return alert("–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 8 —Å–∏–º–≤–æ–ª—ñ–≤.");
    if(p1 !== p2) return alert("–ü–∞—Ä–æ–ª—ñ –Ω–µ –∑–±—ñ–≥–∞—é—Ç—å—Å—è.");

    const { error } = await sb.auth.updateUser({ password: p1 });
    if(error){
      console.error("updateUser(password) error:", error);
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –ø–∞—Ä–æ–ª—å. –î–∏–≤–∏—Å—å Console.");
      return;
    }

    alert("–ü–∞—Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ. –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥–∏ –∑ –Ω–æ–≤–∏–º –ø–∞—Ä–æ–ª–µ–º.");
    isRecoveryMode = false;
    showResetCard(false);

    // —á–∏—Å—Ç–∏–º–æ URL, —â–æ–± –Ω–µ –∑–∞–ª–∏–ø–∞–≤ recovery-—Ä–µ–∂–∏–º
    try { history.replaceState({}, document.title, window.location.pathname); } catch(e) {}

    // –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏—Ö–æ–¥–∏–º–æ, —â–æ–± –ù–ï –±—É–ª–æ –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–ª–∞–Ω–µ—Ä–∞ –¥–æ –Ω–æ–≤–æ–≥–æ –ª–æ–≥—ñ–Ω—É
    try { await sb.auth.signOut({ scope:"local" }); } catch(e) {}
    try { forceClearSupabaseAuth(); } catch(e) {}

    currentSession = null;
    setAuthUI(null);
    try { render(); } catch(e) {}
  });
}

// 3) Show reset UI on PASSWORD_RECOVERY
// –í–ê–ñ–õ–ò–í–û: callback –Ω–µ —Ä–æ–±–∏ async –∑ await –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ.
// –Ø–∫—â–æ —Ç—Ä–µ–±–∞ await ‚Äî —Ä–æ–±–∏–º–æ setTimeout(...,0)
sb.auth.onAuthStateChange((event, session) => {
  if(event === "PASSWORD_RECOVERY"){
    isRecoveryMode = true;
    currentSession = session || currentSession;

    showResetCard(true);
    setAuthUI(currentSession, { recovery: true });

    // –≤–∞–∂–ª–∏–≤–æ: –ù–ï —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–ª–∞–Ω–µ—Ä/roster/DB
    clearAppOnLogout();
  }
});

// === Realtime conflict control (nextWeek only) ===
// Goal: prevent "last write wins" overwrites when several users edit simultaneously.
// Mechanism: optimistic concurrency check on planner_weeks.updated_at + auto-merge of ONLY the local edits.
let nextWeekDbUpdatedAt = null;   // last known updated_at in DB for nextWeekStart
let nextWeekDbSnapshot = null;    // last known DB week (WITHOUT local edits), used to compute local-diff ops

function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }

function computeWeekOps(baseWeek, currentWeek){
  const ops = [];

  const b = baseWeek || emptyWeek();
  const c = currentWeek || emptyWeek();

  // reservations: [dateIso][userId] -> mode
  const bRes = b.reservations || {};
  const cRes = c.reservations || {};
  const dates = new Set([...Object.keys(bRes), ...Object.keys(cRes)]);

  for(const dateIso of dates){
    const bDay = bRes[dateIso] || {};
    const cDay = cRes[dateIso] || {};
    const uids = new Set([...Object.keys(bDay), ...Object.keys(cDay)]);
    for(const uid of uids){
      const bv = bDay[uid] ?? null;
      const cv = cDay[uid] ?? null;
      if(bv !== cv){
        ops.push({ t: "set_reservation", dateIso, userId: uid, mode: cv });
      }
    }
  }

  // dayOff: [dateIso] -> boolean
  const bOff = b.dayOff || {};
  const cOff = c.dayOff || {};
  const offDates = new Set([...Object.keys(bOff), ...Object.keys(cOff)]);
  for(const dateIso of offDates){
    const bv = !!bOff[dateIso];
    const cv = !!cOff[dateIso];
    if(bv !== cv){
      ops.push({ t: "set_dayoff", dateIso, value: cv });
    }
  }

  // status / approval meta
  const bStatus = b.status || "draft";
  const cStatus = c.status || "draft";
  const bBy = b.approvedBy || null;
  const cBy = c.approvedBy || null;
  const bAt = b.approvedAt || null;
  const cAt = c.approvedAt || null;

  if(bStatus !== cStatus || bBy !== cBy || bAt !== cAt){
    ops.push({ t: "set_meta", status: cStatus, approvedBy: cBy, approvedAt: cAt });
  }

  return ops;
}

function applyWeekOps(targetWeek, ops){
  const w = targetWeek;

  for(const op of ops){
    if(op.t === "set_reservation"){
      if(!w.reservations) w.reservations = {};
      if(!w.reservations[op.dateIso]) w.reservations[op.dateIso] = {};
      if(op.mode === null || op.mode === undefined || op.mode === ""){
        delete w.reservations[op.dateIso][op.userId];
      }else{
        w.reservations[op.dateIso][op.userId] = op.mode;
      }
    }

    if(op.t === "set_dayoff"){
      if(!w.dayOff) w.dayOff = {};
      w.dayOff[op.dateIso] = !!op.value;
    }

    if(op.t === "set_meta"){
      w.status = op.status || "draft";
      w.approvedBy = op.approvedBy || null;
      w.approvedAt = op.approvedAt || null;
    }
  }
}

async function getSession(){
  const { data: { session } } = await sb.auth.getSession();
  currentSession = session;
  return session;
}

function isLoggedIn(){
  return !!currentSession?.user;
}

function setAuthUI(session, opts = {}){
  const authCard = document.getElementById("authCard");
  const loginBlock = document.getElementById("loginFields");
  const authState = document.getElementById("authStatus");
  const btnLogout = document.getElementById("btnLogout");
  const afterLogin = document.getElementById("afterLogin");

  const recovery = !!opts.recovery;
  const loggedIn = !!session?.user && !recovery;

  if(authCard) authCard.style.display = "block";

  if(recovery){
    if(loginBlock) loginBlock.style.display = "none";
    if(btnLogout) btnLogout.style.display = "none";
    if(afterLogin) afterLogin.style.display = "none";
    if(authState) authState.textContent = "Password recovery: set a new password";
    return;
  }

  if(loginBlock) loginBlock.style.display = loggedIn ? "none" : "flex";
  if(btnLogout) btnLogout.style.display = loggedIn ? "inline-flex" : "none";
  if(afterLogin) afterLogin.style.display = loggedIn ? "block" : "none";

  if(authState){
    authState.textContent = loggedIn
      ? `Logged in: ${session.user.email}`
      : "Not logged in";
  }

  // —è–∫—â–æ —Ä–æ–∑–ª–æ–≥—ñ–Ω–∏–ª–∏—Å—å ‚Äî –ø—Ä–∏–±—Ä–∞—Ç–∏ DOM —Ç–∏–∂–Ω—ñ–≤
  if(!loggedIn){
    const n = document.getElementById("nextWeekCard");
    const t = document.getElementById("thisWeekCard");
    if(n) n.innerHTML = "";
    if(t) t.innerHTML = "";
  }
}


// helper: don't let network waits block UI forever
function withTimeout(promise, ms){
  return Promise.race([
    promise,
    new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), ms))
  ]);
}

  function supabaseRef(){
  // https://xxxx.supabase.co -> xxxx
  try { return new URL(SUPABASE_URL).hostname.split(".")[0]; }
  catch { return null; }
}

function forceClearSupabaseAuth(){
  const ref = supabaseRef();
  if(!ref) return;

  const prefix = `sb-${ref}-`;
  // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∫–ª—é—á—ñ, —è–∫—ñ —Å—Ç–≤–æ—Ä—é—î supabase-js auth
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(prefix)) localStorage.removeItem(k);
  }
}

document.getElementById("btnLogin").addEventListener("click", async (e) => {
  e.preventDefault();

  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPass").value;

  // small UI hint
  const authState = document.getElementById("authStatus");
  if(authState) authState.textContent = "Logging in‚Ä¶";

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){
    alert("Login error: " + error.message);
    if(authState) authState.textContent = "Not logged in";
    return;
  }

  // Fallback: even if onAuthStateChange is slow, update UI right away
  const { data: { session } } = await sb.auth.getSession();
  currentSession = session;
  setAuthUI(session);

  
  // realtime only for authenticated users
  if(isLoggedIn()){
    startRealtimeForNextWeek();
    startRealtimeForThisWeek();
  }else{
    stopRealtime();
  }

  render();
// load week in background (don‚Äôt block UI)
  if(isLoggedIn()){
    withTimeout(loadNextWeekFromDB(), 2500)
      .catch(err => console.warn("loadNextWeekFromDB timeout/error:", err))
      .finally(() => render());
  }
});


document.getElementById("btnLogout").addEventListener("click", async (e) => {
  e.preventDefault();

  // instant UI update (even if network is blocked)
  currentSession = null;
  setAuthUI(null);
  try { render(); } catch(_) {}

  // hard clear local auth storage
  try { forceClearSupabaseAuth(); } catch(_) {}

  // try Supabase signOut, but don't let it hang forever
  try{
    await withTimeout(sb.auth.signOut({ scope: "local" }), 1500);
  }catch(err){
    console.warn("signOut timeout/error:", err);
  }

  // final clear + hard reload to ensure app state resets
  try { forceClearSupabaseAuth(); } catch(_) {}
  location.reload();
});


  
/** =============================
 * 0) Team / roster (from profiles)
 *  - TEAM –±—É–¥—É—î—Ç—å—Å—è –∑ —Ç–∞–±–ª–∏—Ü—ñ public.profiles (id, email, full_name, role)
 *  - legacy-–º–µ–ø—ñ–Ω–≥ –ø–æ—Ç—Ä—ñ–±–µ–Ω –ª–∏—à–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó —Å—Ç–∞—Ä–∏—Ö –¥–∞–Ω–∏—Ö (u1/u2/...)
 * ============================= */

let TEAM = [];      // [{ id (uuid), name, role: "employee"|"manager", email }]
let EMAILS = {};    // { [uuid]: email }


function buildTeamFromProfiles(){
  const list = (PROFILES || []).map(p => {
    const role = (p.role === "manager") ? "manager" : "employee";
return {
  id: p.id,
  name: p.full_name || p.email || p.id,
  role,
  email: p.email || null,
  last_name: p.last_name || null 
};
  }).filter(x => !!x.id);

  // employees ‚Üí managers, –¥–∞–ª—ñ –∑–∞ name
  list.sort((a,b) => {
    if(a.role !== b.role) return (a.role === "manager") ? 1 : -1;
    return String(a.name).localeCompare(String(b.name), "uk", { sensitivity:"base" });
  });

  TEAM = list;

  EMAILS = {};
  TEAM.forEach(u => { if(u.email) EMAILS[u.id] = u.email; });
}

function getUserNameById(uid){
  return TEAM.find(u => u.id === uid)?.name || PROFILE_BY_ID?.[uid]?.full_name || PROFILE_BY_ID?.[uid]?.email || uid;
}

function setMeToLoggedInUser(){
  const meSel = document.getElementById("me");
  const meName = document.getElementById("meName");

  const uid = currentSession?.user?.id;
  if(!uid) return;

  if(meSel){
    meSel.value = uid;
    meSel.disabled = true;
    meSel.style.display = "none"; // ‚úÖ –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –≤–∏–±—ñ—Ä –ø—ñ—Å–ª—è –ª–æ–≥—ñ–Ω—É
  }
  if(meName){
    meName.textContent = getUserNameById(uid);
    meName.style.display = "inline-flex";
  }
}

const LIMIT_REMOTE_PER_DAY = 2;
const LS_KEY = "hybrid_league_v2";

/** =============================
 * 1) Date helpers (LOCAL, no UTC shift)
 * ============================= */

function mondayOf(date){
  const d = new Date(date);
  const day = (d.getDay() + 6) % 7; // Mon=0
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() - day);
  return d;
}
function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
}
function isoDate(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function monthKey(d){
  const x = new Date(d);
  return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}`;
}
async function loadMyProfile(){
  const { data: { user } } = await sb.auth.getUser();
  if(!user) return null;

  const { data, error } = await sb
    .from("profiles")
    .select("id,email,full_name,role,last_name")
    .eq("id", user.id)
    .single();

  if(error){
    console.error("loadMyProfile error:", error);
    return null;
  }
  return data;
}

// =============================
// Profiles cache (for owner names)
// =============================
let PROFILES = [];
let PROFILE_BY_ID = {};
  
// === Tech mapping for LD: last_name -> userId ===
let LASTNAME_TO_ID = {}; // { "–ø–µ—Ç—Ä–µ–Ω–∫–æ": "uuid" }

function normLastName(s){
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ");
}

function buildLastNameIndexFromProfiles(){
  LASTNAME_TO_ID = {};

  for(const p of (PROFILES || [])){
    const ln = normLastName(p?.last_name);
    if(!p?.id || !ln) continue;

    // —è–∫—â–æ —Ä–∞–ø—Ç–æ–º –¥—É–±–ª—å –ø—Ä—ñ–∑–≤–∏—â–∞ ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ –ø–µ—Ä—à–∏–π —ñ –ª–æ–≥ —É –∫–æ–Ω—Å–æ–ª—å
    if(LASTNAME_TO_ID[ln] && LASTNAME_TO_ID[ln] !== p.id){
      console.warn("[LD MATCH] duplicate last_name in profiles:", ln, LASTNAME_TO_ID[ln], p.id);
      continue;
    }
    LASTNAME_TO_ID[ln] = p.id;
  }
}
  
  // === Birthdays (MM-DD) ===
let BIRTHDAY_MMDD_BY_ID = {}; // { [userId]: "MM-DD" }

function buildBirthdaysFromProfiles(){
  BIRTHDAY_MMDD_BY_ID = {};
  (PROFILES || []).forEach(p => {
    if(p?.id && p?.birth_mmdd) BIRTHDAY_MMDD_BY_ID[p.id] = String(p.birth_mmdd).trim();
  });
}

function birthdaysOnDate(dateIso){
  // dateIso: "YYYY-MM-DD" -> "MM-DD"
  const md = String(dateIso).slice(5);
  const names = TEAM
    .filter(isEmployee)
    .filter(u => (BIRTHDAY_MMDD_BY_ID[u.id] || "") === md)
    .map(u => u.name);
  return names;
}
  
async function refreshProfilesCache(){
  // –Ω–µ –±–ª–æ–∫—É—î–º–æ —Ä–æ–±–æ—Ç—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É, —è–∫—â–æ profiles –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ
  const { data, error } = await sb
    .from("profiles")
    .select("id,email,full_name,role,birth_mmdd,last_name");

  if(error){
    console.warn("refreshProfilesCache error:", error);
    PROFILES = [];
    PROFILE_BY_ID = {};
    return;
  }

  PROFILES = data || [];
  PROFILE_BY_ID = {};
  PROFILES.forEach(p => { PROFILE_BY_ID[p.id] = p; });
}

function weekToRow(weekStartIso){
  const w = getWeek(weekStartIso);

  // supabase schema: planner_weeks.week_start (date), status, approved_by(uuid), approved_at, reservations(jsonb), day_off(jsonb)
  return {
    week_start: weekStartIso,                 // "YYYY-MM-DD"
    status: w.status || "draft",
    approved_by: (w.status === "approved") ? (w.approvedBy || currentSession?.user?.id || null) : null,
    approved_at: (w.status === "approved") ? (w.approvedAt || new Date().toISOString()) : null,
    reservations: w.reservations || {},
    day_off: w.dayOff || {},
    overrides: w.overrides || {},     
  };
}

function rowToWeek(row){
  const week = {
    status: row.status || "draft",
    // ‚úÖ —Ä–µ–∞–ª—å–Ω–∏–π owner (uuid –∑ profiles/auth.users)
    approvedBy: row.approved_by || null,
    approvedAt: row.approved_at || null,
    reservations: row.reservations || {},
    dayOff: row.day_off || {},
    overrides: row.overrides || {}, 
    duels: {},
    dayMeta: {},
  };

  return week;
}

async function loadNextWeekFromDB(){
  if(!isLoggedIn()) return;

  const { data, error } = await sb
    .from("planner_weeks")
    .select("*")
    .eq("week_start", nextWeekStart)
    .maybeSingle();

  if(error){
    console.error("loadNextWeekFromDB error:", error);
    return;
  }

  if(!data){
    // —è–∫—â–æ –∑–∞–ø–∏—Å—É –Ω–µ–º–∞ ‚Äî —Å—Ç–≤–æ—Ä–∏–º–æ –∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ state
    await saveNextWeekToDB(true);
    return;
  }

  nextWeekDbUpdatedAt = data.updated_at || null;

  const dbWeek = { ...emptyWeek(), ...rowToWeek(data) };
  nextWeekDbSnapshot = deepCopy(dbWeek);

  // –ù–∞ —Å—Ç–∞—Ä—Ç—ñ –ë–î ‚Äî –¥–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏ (—â–æ–± –Ω–µ –ø—ñ–¥–º—ñ–Ω—è—Ç–∏ —á—É–∂—ñ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ä–∏–º localStorage)
  state.weeks[nextWeekStart] = dbWeek;
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}


async function loadThisWeekFromDB(){
  if(!isLoggedIn()) return;

  const { data, error } = await sb
    .from("planner_weeks")
    .select("*")
    .eq("week_start", thisWeekStart)
    .maybeSingle();

  if(error){
    console.error("loadThisWeekFromDB error:", error);
    return;
  }

  // —è–∫—â–æ –∑–∞–ø–∏—Å—É –Ω–µ–º–∞ ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ —Å—Ç–≤–æ—Ä—é—î–º–æ (—Ü–µ –ø–µ—Ä–µ–≥–ª—è–¥–æ–≤–∏–π —Ç–∏–∂–¥–µ–Ω—å)
  if(!data) return;

  state.weeks[thisWeekStart] = { ...emptyWeek(), ...rowToWeek(data) };
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

async function saveNextWeekToDB(){
  if(!isLoggedIn()) return;

  // –Ω–µ –∑–∞–ø—É—Å–∫–∞—î–º–æ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –∑–∞–ø–∏—Å–∏ (debounce –º–æ–∂–µ —Å—Ç—Ä—ñ–ª—è—Ç–∏ —á–∞—Å—Ç–æ)
  if(saveNextWeekToDB._inFlight) return;
  saveNextWeekToDB._inFlight = true;

  try{
    const row = weekToRow(nextWeekStart);

    // –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ –≤—ñ–¥–Ω–æ—Å–Ω–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ DB snapshot (–¥–ª—è –º'—è–∫–æ–≥–æ –º–µ—Ä–¥–∂—É –ø—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ)
    const baseSnap = nextWeekDbSnapshot || emptyWeek();
    const localWeek = deepCopy(getWeek(nextWeekStart));
    const localOps = computeWeekOps(baseSnap, localWeek);

    // 1) –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–∏–π UPDATE (—â–æ–± –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ —á—É–∂—ñ –∑–º—ñ–Ω–∏ ‚Äú–ø–æ–≤–µ—Ä—Ö‚Äù)
    if(nextWeekDbUpdatedAt){
      const payload = { ...row };
      delete payload.week_start; // PK –Ω–µ –æ–Ω–æ–≤–ª—é—î–º–æ

      let { data, error } = await sb
        .from("planner_weeks")
        .update(payload)
        .eq("week_start", nextWeekStart)
        .eq("updated_at", nextWeekDbUpdatedAt) // optimistic lock
        .select("*")
        .maybeSingle();

      if(error){
        console.error("saveNextWeekToDB update error:", error);
        return;
      }

      // data == null => 0 rows matched => —Ö—Ç–æ—Å—å –≤—Å—Ç–∏–≥ –æ–Ω–æ–≤–∏—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å —Ä–∞–Ω—ñ—à–µ
      if(!data){
        // 1.1) –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è (—Ä–∞–∑ –Ω–∞ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥)
        const now = Date.now();
        if(!saveNextWeekToDB._lastWarnAt || now - saveNextWeekToDB._lastWarnAt > 3000){
          saveNextWeekToDB._lastWarnAt = now;
          alert("‚ö†Ô∏è –•—Ç–æ—Å—å —É–∂–µ –∑–º—ñ–Ω–∏–≤ —Ü–µ–π —Ç–∏–∂–¥–µ–Ω—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ. –Ø –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ. –Ø–∫—â–æ –ø–æ–±–∞—á–∏—à –¥–∏–≤–Ω–µ ‚Äî –∑—Ä–æ–±–∏ Refresh —Å—Ç–æ—Ä—ñ–Ω–∫–∏.");
        }

        // 1.2) –ü—ñ–¥—Ç—è–≥—É—î–º–æ —Å–≤—ñ–∂—É –≤–µ—Ä—Å—ñ—é –∑ –ë–î —ñ –ú‚Äô–Ø–ö–û –Ω–∞–∫–ª–∞–¥–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏
        await loadNextWeekFromDB(); // –æ–Ω–æ–≤–∏—Ç—å nextWeekDbUpdatedAt/nextWeekDbSnapshot + state.weeks[nextWeekStart]
        try{
          applyWeekOps(state.weeks[nextWeekStart], localOps);
          localStorage.setItem(LS_KEY, JSON.stringify(state));
        }catch(e){
          console.error("applyWeekOps after conflict failed:", e);
        }

        render();

        // 1.3) –°–ø—Ä–æ–±—É—î–º–æ –∑–∞–ø–∏—Å–∞—Ç–∏ —â–µ —Ä–∞–∑ (–≤–∂–µ –∑ –Ω–æ–≤–∏–º updated_at)
        const row2 = weekToRow(nextWeekStart);
        const payload2 = { ...row2 };
        delete payload2.week_start;

        const r2 = await sb
          .from("planner_weeks")
          .update(payload2)
          .eq("week_start", nextWeekStart)
          .eq("updated_at", nextWeekDbUpdatedAt)
          .select("*")
          .maybeSingle();

        if(r2.error){
          console.error("saveNextWeekToDB retry error:", r2.error);
          return;
        }
        if(!r2.data){
          console.warn("saveNextWeekToDB: still conflict after retry (ask user to refresh)");
          return;
        }

        // —É—Å–ø—ñ—à–Ω–æ
        nextWeekDbUpdatedAt = r2.data.updated_at || nextWeekDbUpdatedAt;
        nextWeekDbSnapshot = deepCopy(rowToWeek(r2.data));
        return;
      }

      // —É—Å–ø—ñ—Ö –∑ –ø–µ—Ä—à–æ–≥–æ —Ä–∞–∑—É
      nextWeekDbUpdatedAt = data.updated_at || nextWeekDbUpdatedAt;
      nextWeekDbSnapshot = deepCopy(rowToWeek(data));
      return;
    }

    // 2) –Ø–∫—â–æ updated_at —â–µ –Ω–µ –∑–Ω–∞—î–º–æ ‚Äî –ø—Ä–æ—Å—Ç–æ upsert (–ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å —Ç–∏–∂–Ω—è)
    const { data, error } = await sb
      .from("planner_weeks")
      .upsert(row, { onConflict: "week_start" })
      .select("*")
      .maybeSingle();

    if(error){
      console.error("saveNextWeekToDB upsert error:", error);
      return;
    }
    if(data){
      nextWeekDbUpdatedAt = data.updated_at || nextWeekDbUpdatedAt;
      nextWeekDbSnapshot = deepCopy(rowToWeek(data));
    }
  } finally {
    saveNextWeekToDB._inFlight = false;
  }
}
let saveNextWeekTimer = null;

function queueSaveNextWeekToDB(){
  if(!isLoggedIn()) return;

  clearTimeout(saveNextWeekTimer);
  saveNextWeekTimer = setTimeout(() => {
    saveNextWeekToDB();
  }, 400); // 300‚Äì500 –º—Å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
}


/** =============================
 * 2) State model
 *  - store per weekStart: weeks[weekStartIso] = {status, reservations, approvedBy, approvedAt}
 *  - global: tokensMonth, tokens, stats
 * ============================= */
function emptyWeek(){
  return {
    status: "draft",
    approvedBy: null,
    approvedAt: null,
    reservations: {},   // dateIso -> { userId: mode }
    duels: {},          // dateIso -> { attempts: { [userId]: number }, total: number }
    dayMeta: {},        // dateIso -> { ts: { [userId]: number } }
dayOff: {},         // dateIso -> true
overrides: {}       // dateIso -> { [userId]: { by, at, from, to, note } }
  };
}

function initTokens(){
  const t = {};
  TEAM.filter(u=>u.role!=="manager").forEach(u => t[u.id] = 1);
  return t;
}
function defaultState(){
  return {
    weeks: {},
    tokensMonth: monthKey(new Date()),
    tokens: initTokens(),
    stats: (() => {
      const s = {};
      TEAM.forEach(u => s[u.id] = { w:0, l:0 });
      return s;
    })()
  };
}
function loadState(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return defaultState();
  try {
    const parsed = JSON.parse(raw);

    if(!parsed.weeks) parsed.weeks = {};
    if(!parsed.stats) {
      parsed.stats = {};
      TEAM.forEach(u => parsed.stats[u.id] = { w:0, l:0 });
    }
    if(!parsed.tokensMonth) parsed.tokensMonth = monthKey(new Date());
    if(!parsed.tokens) parsed.tokens = initTokens();

 // ‚úÖ –º—ñ–≥—Ä–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
Object.values(parsed.weeks).forEach(w => {
  if(!w.dayOff) w.dayOff = {};
  if(!w.reservations) w.reservations = {};
  if(!w.status) w.status = "draft";
if(!w.overrides) w.overrides = {};

  // –Ω–æ–≤–µ –¥–ª—è –¥—É–µ–ª–µ–π
  if(!w.duels) w.duels = {};
  if(!w.dayMeta) w.dayMeta = {};
});

    return parsed;
  } catch(e){
    return defaultState();
  }
}

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));

  // –ø–∏—à–µ–º–æ –≤ Supabase —Ç—ñ–ª—å–∫–∏ nextWeekStart
  // (—ñ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω—ñ)
  // –ø–∏—à–µ–º–æ –≤ Supabase —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ —Ü–µ –ù–ï apply –∑ realtime
  if(!rtApplying) queueSaveNextWeekToDB();

  if (typeof meSel !== "undefined" && meSel) render();
}

let state = null;
function ensureMonthlyTokens(){
  const mk = monthKey(new Date());
  if(state.tokensMonth !== mk){
    state.tokensMonth = mk;
    state.tokens = initTokens();
    saveState();
  }
}

function getWeek(weekStartIso){
if(!state.weeks[weekStartIso]) state.weeks[weekStartIso] = emptyWeek();
return state.weeks[weekStartIso];
}

function getDuelState(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  if(!w.duels) w.duels = {};
  if(!w.duels[dateIso]) w.duels[dateIso] = { attempts:{}, total:0 };
  return w.duels[dateIso];
}

function isDayOff(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  if(!w.dayOff) w.dayOff = {};
  return !!w.dayOff[dateIso];
}

function toggleDayOff(weekStartIso, dateIso){
  const me = currentUser();
  if(me.role !== "manager") return alert("–õ–∏—à–µ –∫–µ—Ä—ñ–≤–Ω–∏–∫ –º–æ–∂–µ —Å—Ç–∞–≤–∏—Ç–∏ –≤–∏—Ö—ñ–¥–Ω–∏–π –¥–µ–Ω—å.");
  const w = getWeek(weekStartIso);
  if(!w.dayOff) w.dayOff = {};
  w.dayOff[dateIso] = !w.dayOff[dateIso];
  saveState();
}

function canManagerOverride(weekStartIso){
  const me = currentUser();
  if(!me || me.role !== "manager") return false;

  const w = getWeek(weekStartIso);
  // override —Ç—ñ–ª—å–∫–∏ –¥–æ approve —ñ –¥–æ lock
  if(w.status === "approved" || w.status === "locked") return false;

  return true;
}

function setManagerOverride(weekStartIso, dateIso, userId, newMode){
  if(!canManagerOverride(weekStartIso)) return alert("Override –¥–æ—Å—Ç—É–ø–Ω–∏–π –∫–µ—Ä—ñ–≤–Ω–∏–∫—É –ª–∏—à–µ –î–û Approve.");

  const w = getWeek(weekStartIso);
  if(!w.reservations[dateIso]) w.reservations[dateIso] = {};
  if(!w.overrides) w.overrides = {};
  if(!w.overrides[dateIso]) w.overrides[dateIso] = {};

  const before = w.reservations[dateIso][userId] || "office";
  const after  = newMode;

  // —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–º—ñ–Ω—é—î–º–æ ‚Äî –≤–∏—Ö–æ–¥–∏–º–æ
  if(before === after) return;

  const me = currentUser();
  const note = prompt("–ü—Ä–∏—á–∏–Ω–∞ (–∫–æ—Ä–æ—Ç–∫–æ). –ú–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º:", "") || "";

  // —Å—Ç–∞–≤–∏–º–æ —Ä–µ–∂–∏–º
  w.reservations[dateIso][userId] = after;

  // —Ñ—ñ–∫—Å—É—î–º–æ override
  w.overrides[dateIso][userId] = {
    by: me.id,
    at: Date.now(),
    from: before,
    to: after,
    note
  };

  saveState();
}

function formatModeUA(mode){
  if(mode === "remote") return "Remote";
  if(mode === "remote_pending") return "Remote (OK?)";
  if(mode === "vacation") return "–í—ñ–¥–ø—É—Å—Ç–∫–∞";
  return "Office";
}


/** =============================
 * 3) Week keys (computed in boot, after roster + state)
 * ============================= */
let thisWeekStart = null;
let nextWeekStart = null;

function initWeekKeys(){
  thisWeekStart = isoDate(mondayOf(new Date()));
  nextWeekStart = isoDate(addDays(new Date(thisWeekStart), 7));

  if(state){
    getWeek(thisWeekStart);
    getWeek(nextWeekStart);
    ensureMonthlyTokens();
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }
}

/** =============================
 * 4) UI init
 * ============================= */
const meSel = document.getElementById("me");

function initRosterUI(){
  if(!meSel) return;
  meSel.innerHTML = "";
  TEAM.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u.id;
    opt.textContent = `${u.name}${u.role === "manager" ? " (–ú–µ–Ω–µ–¥–∂–µ—Ä)" : ""}`;
    meSel.appendChild(opt);
  });
  // ‚úÖ –ø—ñ—Å–ª—è –ª–æ–≥—ñ–Ω—É –º–∏ —Ñ—ñ–∫—Å—É—î–º–æ meSel –Ω–∞ session.user.id —ñ —Ö–æ–≤–∞—î–º–æ —Å–µ–ª–µ–∫—Ç
  meSel.disabled = true;
  meSel.style.display = "none";
}

const tabNext = document.getElementById("tabNext");
const tabThis = document.getElementById("tabThis");
const paneNext = document.getElementById("paneNext");
const paneThis = document.getElementById("paneThis");

// –¥–µ—Ñ–æ–ª—Ç ‚Äî next
function setTab(which){
  const isNext = which === "next";
  tabNext.classList.toggle("active", isNext);
  tabThis.classList.toggle("active", !isNext);
  paneNext.classList.toggle("active", isNext);
  paneThis.classList.toggle("active", !isNext);
}
tabNext.onclick = () => setTab("next");
tabThis.onclick = () => setTab("this");
setTab("next");

const btnReset = document.getElementById("btnReset");
if(btnReset){
  btnReset.style.display = "none"; // —Ö–æ–≤–∞—î–º–æ –¥–ª—è –≤—Å—ñ—Ö
  btnReset.onclick = null;         // –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
}

const btnToggleFilled = document.getElementById("btnToggleFilled");
if(btnToggleFilled){
  btnToggleFilled.addEventListener("click", toggleMySubmission);
}

/** =============================
 * 5) Counters
 * ============================= */
function countRemoteDay(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  const day = w.reservations[dateIso] || {};
  return Object.values(day).filter(v => v === "remote" || v === "remote_pending").length;
}
function countMyRemoteDays(weekStartIso, userId){
  const w = getWeek(weekStartIso);
  let c = 0;
  const ws = new Date(weekStartIso);
  for(let i=0;i<5;i++){
    const dIso = isoDate(addDays(ws,i));
    const day = w.reservations[dIso] || {};
    const v = day[userId];
    if(v === "remote" || v === "remote_pending") c++;
  }
  return c;
}
function hasPendingInDay(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  const day = w.reservations[dateIso] || {};
  return Object.values(day).some(v => v === "remote_pending");
}
function currentUser(){
  const uid = currentSession?.user?.id || meSel?.value;
  return TEAM.find(u => u.id === uid);
}

function winRate(uid){
  const s = state.stats?.[uid] || { w:0, l:0 };
  const total = s.w + s.l;
  return total ? (s.w / total) : 0.5; // —è–∫—â–æ —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ–º–∞ ‚Äî 50/50
}

function getDayMeta(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  if(!w.dayMeta) w.dayMeta = {};
  if(!w.dayMeta[dateIso]) w.dayMeta[dateIso] = { ts:{} };
  if(!w.dayMeta[dateIso].ts) w.dayMeta[dateIso].ts = {};
  return w.dayMeta[dateIso];
}

/**
 * –ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –ø–µ—Ä–µ–º–æ–≥–∏ challenger –ø—Ä–æ—Ç–∏ defender.
 * –õ–æ–≥—ñ–∫–∞: —è–∫—â–æ defender "—Å–∏–ª—å–Ω—ñ—à–∏–π" (—á–∞—Å—Ç—ñ—à–µ –≤–∏–≥—Ä–∞–≤–∞–≤),
 * —Ç–æ challenger –æ—Ç—Ä–∏–º—É—î –±–æ–Ω—É—Å. –ú–µ–∂—ñ 20%..80%.
 */
function fairnessProb(challengerId, defenderId){
  const cr = winRate(challengerId);
  const dr = winRate(defenderId);

  let p = 0.5 + (dr - cr) * 0.30;
  p = Math.max(0.20, Math.min(0.80, p));
  return p;
}

function bumpStats(winnerId, loserId){
  if(!state.stats) state.stats = {};
  if(!state.stats[winnerId]) state.stats[winnerId] = { w:0, l:0 };
  if(!state.stats[loserId])  state.stats[loserId]  = { w:0, l:0 };
  state.stats[winnerId].w++;
  state.stats[loserId].l++;
}


function pickDefender(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  const day = w.reservations[dateIso] || {};
  const meta = (w.dayMeta && w.dayMeta[dateIso] && w.dayMeta[dateIso].ts) ? w.dayMeta[dateIso].ts : {};

  const defenders = Object.entries(day)
    .filter(([uid, mode]) => mode === "remote" || mode === "remote_pending")
    .map(([uid]) => uid);

  if(defenders.length === 0) return null;

  // –Ω–∞–π—Ä–∞–Ω—ñ—à–∏–π timestamp = "–ø–µ—Ä—à–∏–π –∑–∞–π–Ω—è–≤" = defender
  defenders.sort((a,b) => (meta[a] || 0) - (meta[b] || 0));
  return defenders[0];
}

/** =============================
 * 6) Conflict resolver (Token / Fairness)
 * ============================= */
const modalBackdrop = document.getElementById("modalBackdrop");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
document.getElementById("modalClose").onclick = () => closeModal(null);

const btnUseToken = document.getElementById("btnUseToken");
const btnFairRoll = document.getElementById("btnFairRoll");

let modalResolver = null;

function openModal(){
  modalBackdrop.style.display = "flex";

  const modal = modalBackdrop.querySelector(".modal");
  if(!modal) return;

  requestAnimationFrame(() => {
    modal.style.animation = "none";
    modal.offsetHeight; // reflow
    modal.style.animation = "pop 180ms ease both";
  });
}

function closeModal(result){
  modalBackdrop.style.display = "none";
  if(modalResolver) modalResolver(result);
  modalResolver = null;
}

// –ú–∞–ª–µ–Ω—å–∫—ñ —Ö–µ–ª–ø–µ—Ä–∏ UI
function setModalButtonsEnabled(enabled){
  btnUseToken.disabled = !enabled || btnUseToken.dataset.forceDisabled === "1";
  btnFairRoll.disabled = !enabled;
}
function setUseTokenAvailability(canUse){
  btnUseToken.dataset.forceDisabled = canUse ? "0" : "1";
  btnUseToken.disabled = !canUse;
}

function showModalWorking(html){
  // –∑–∞–±–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫–∏, —â–æ–± –Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–ª–∏ –¥–≤—ñ—á—ñ
  setModalButtonsEnabled(false);
  modalBody.innerHTML += `
    <div class="hr"></div>
    <div>${html}</div>
  `;
}

function showModalFinal({ ok, challengerName, defenderName, dateIso, method }){
  const color = ok ? "var(--ok)" : "var(--bad)";
  const icon  = ok ? "‚úÖ" : "‚ùå";
  const title = ok ? "–ü–µ—Ä–µ–º–æ–≥–∞!" : "–ü–æ—Ä–∞–∑–∫–∞";

  modalBody.innerHTML += `
    <div class="hr"></div>
    <div style="font-weight:800; color:${color}; font-size:15px;
                display:flex; gap:8px; align-items:center;">
      <span>${icon}</span>
      <span>${title}</span>
      <span style="font-weight:600; color: var(--muted); font-size:12px;">
        (${method})
      </span>
    </div>
    <div class="muted" style="margin-top:8px; line-height:1.4;">
      ${
        ok
          ? `${challengerName} –æ—Ç—Ä–∏–º—É—î üè† Remote –Ω–∞ <b>${dateIso}</b>.<br/>
             ${defenderName} –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ üè¢ Office.`
          : `${challengerName} –Ω–µ –æ—Ç—Ä–∏–º—É—î Remote –Ω–∞ <b>${dateIso}</b>.<br/>
             ${defenderName} –∑–±–µ—Ä—ñ–≥–∞—î üè† Remote.`
      }
    </div>
    <div class="muted small" style="margin-top:10px;">
      –ó–∞–∫—Ä–∏–π –≤—ñ–∫–Ω–æ, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏
    </div>
  `;
}

/**
 * –ü–æ–∫–∞–∑—É—î –º–æ–¥–∞–ª–∫—É —ñ –ø–æ–≤–µ—Ä—Ç–∞—î –æ–±'—î–∫—Ç —Ä—ñ—à–µ–Ω–Ω—è:
 * { type: "token" } –∞–±–æ { type: "fair", ok: boolean, p: number }
 * (–∞ ‚Äú–ø–µ—Ä–µ–º—ñ–≥/–ø—Ä–æ–≥—Ä–∞–≤‚Äù –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ç—É—Ç –∂–µ —É –º–æ–¥–∞–ª—Ü—ñ)
 */
async function conflictModal({ weekStartIso, dateIso, challenger, defender }){
  ensureMonthlyTokens();

  // –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ
  btnFairRoll.disabled = false;
  btnUseToken.disabled = false;
  btnUseToken.dataset.forceDisabled = "0";

  const myTok = (state.tokens && state.tokens[challenger.id] != null) ? state.tokens[challenger.id] : 0;
  const p = fairnessProb(challenger.id, defender.id);

  modalTitle.textContent = `‚öñÔ∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç –∑–∞ Remote: ${dateIso}`;
  modalBody.innerHTML = `
    <div><b>–ü—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç:</b> ${challenger.name}</div>
    <div><b>–ó–∞—Ö–∏—Å–Ω–∏–∫ —Å–ª–æ—Ç—É:</b> ${defender.name}</div>
    <div class="hr"></div>
    <div class="muted">
      üéüÔ∏è –¢–æ–∫–µ–Ω–∏ –ø—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç–∞: <b>${myTok}/1</b> (—Ç–æ–∫–µ–Ω = –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞ –ø–µ—Ä–µ–º–æ–≥–∞).
      <br/>‚öñÔ∏è Fairness roll: —à–∞–Ω—Å –ø—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç–∞ ‚âà <b>${Math.round(p*100)}%</b>.
    </div>
  `;

  setUseTokenAvailability(myTok > 0);
  setModalButtonsEnabled(true);
  openModal();

  // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ Promise, —è–∫–∏–π —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑—Ä–æ–±–∏—Ç—å –≤–∏–±—ñ—Ä
  const choice = await new Promise(resolve => {
    modalResolver = resolve;

    btnUseToken.onclick = () => resolve("token");
    btnFairRoll.onclick = () => resolve("fair");
  });

  // —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–∫—Ä–∏–≤ –º–æ–¥–∞–ª–∫—É —Ö—Ä–µ—Å—Ç–∏–∫–æ–º
  if(choice == null){
    closeModal(null);
    return null;
  }

  if(choice === "token"){
    showModalWorking(`<b>üéüÔ∏è –¢–æ–∫–µ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ.</b> Remote –±—É–¥–µ –∑–∞ –ø—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç–æ–º.`);
    // "token" –∑–∞–≤–∂–¥–∏ ok=true
    showModalFinal({
      ok: true,
      challengerName: challenger.name,
      defenderName: defender.name,
      dateIso,
      method: "token"
    });
    return { type:"token" };
  }

  // fairness
  showModalWorking(`<b>‚öñÔ∏è Fairness roll‚Ä¶</b> –†–∞—Ö—É—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç.`);
  const ok = (Math.random() < p);

  showModalFinal({
    ok,
    challengerName: challenger.name,
    defenderName: defender.name,
    dateIso,
    method: `fairness ${Math.round(p*100)}%`
  });

  return { type:"fair", ok, p };
}

/** =============================
 * 7) Rendering
 * ============================= */
function render(){
  // guards
  const thisCard = document.getElementById("thisWeekCard");
  const nextCard = document.getElementById("nextWeekCard");

  if(!isLoggedIn()){
    if(thisCard) thisCard.innerHTML = `<div class="muted">–£–≤—ñ–π–¥–∏, —â–æ–± –±–∞—á–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.</div>`;
    if(nextCard) nextCard.innerHTML = `<div class="muted">–£–≤—ñ–π–¥–∏, —â–æ–± –±–∞—á–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.</div>`;
    return;
  }

  if(!state || !thisWeekStart || !nextWeekStart || TEAM.length === 0){
    if(thisCard) thisCard.innerHTML = `<div class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>`;
    if(nextCard) nextCard.innerHTML = `<div class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>`;
    return;
  }

  ensureMonthlyTokens();
renderManagerControls();
  renderManagerYtdStats();

  // top counters for NEXT week only (planning)
  const me = currentUser();
// hide personal counters for manager
  const isMgr = me.role === "manager";
  document.querySelectorAll(".onlyEmployee").forEach(el => {
    el.classList.toggle("hidden", isMgr);
  });
  const myId = me.id;

const remoteEl = document.getElementById("myRemoteCount");

if(me.role === "manager"){
  // –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –æ–±–∏—Ä–∞—î –¥–Ω—ñ => –ª—ñ–º—ñ—Ç –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ
  if(remoteEl) remoteEl.style.display = "none";
} else {
  if(remoteEl){
    remoteEl.style.display = "";
    const myRemoteNext = countMyRemoteDays(nextWeekStart, myId);
    remoteEl.textContent = `${myRemoteNext}/2`;
    remoteEl.className = "pill my-remote" + (myRemoteNext > 2 ? " warn" : "");
  }
}

  const myTok = (state.tokens && state.tokens[myId] != null) ? state.tokens[myId] : 0;
  document.getElementById("myTokens").textContent = `${myTok}/1`;

  // render weeks
  renderWeekCard("thisWeekCard", thisWeekStart, true);   // read-only for users
  renderWeekCard("nextWeekCard", nextWeekStart, false);  // editable for employees (unless locked)

notifyOverridesForMe(nextWeekStart);
  renderFillBar();  
}

function renderManagerControls(){
  const host = document.getElementById("mgrControls");
  if(!host) return;

  const me = currentUser();
  if(!me || me.role !== "manager"){
    host.innerHTML = "";
    return;
  }

  const w = getWeek(nextWeekStart);
  const isApproved = (w.status === "approved");

host.innerHTML = `
  <button id="mgrApprove" class="ok" ${isApproved ? "disabled" : ""}>Approve week</button>
  <button id="mgrUnapprove" class="bad" ${isApproved ? "" : "disabled"} title="–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ draft">Unapprove</button>

<button id="mgrEmailBlast"
        type="button"
        class="mailIconBtn"
        title="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–æ–∑—Å–∏–ª–∫—É (EML)"
        aria-label="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–æ–∑—Å–∏–ª–∫—É (EML)">
  ‚úâÔ∏è
</button>
`;

  const btnApprove = document.getElementById("mgrApprove");
  const btnUnapprove = document.getElementById("mgrUnapprove");
  const btnEmail = document.getElementById("mgrEmailBlast");

  // –í–∏–±—ñ—Ä —Ç–∏–∂–Ω—è –¥–ª—è —Ä–æ–∑—Å–∏–ª–∫–∏:
  // - —è–∫—â–æ nextWeek approved -> —à–ª–µ–º–æ –π–æ–≥–æ
  // - —ñ–Ω–∞–∫—à–µ, —è–∫—â–æ thisWeek approved -> —à–ª–µ–º–æ thisWeek
  // - —ñ–Ω–∞–∫—à–µ –∫–Ω–æ–ø–∫–∞ disabled (–Ω–µ–º–∞ –∂–æ–¥–Ω–æ–≥–æ approved)
  const wNext = getWeek(nextWeekStart);
  const wThis = getWeek(thisWeekStart);

  const targetWeekStart =
    (wNext?.status === "approved") ? nextWeekStart :
    (wThis?.status === "approved") ? thisWeekStart :
    null;

  if(btnEmail){
    btnEmail.disabled = !targetWeekStart;
    btnEmail.title = targetWeekStart
      ? `–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ EML –¥–ª—è —Ç–∏–∂–Ω—è ${targetWeekStart} (approved)`
      : "–ù–µ–º–∞—î –ø–æ–≥–æ–¥–∂–µ–Ω–æ–≥–æ —Ç–∏–∂–Ω—è (approved) ‚Äî EML –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.";

    btnEmail.onclick = () => {
      if(!targetWeekStart){
        alert("–ù–µ–º–∞—î –ø–æ–≥–æ–¥–∂–µ–Ω–æ–≥–æ —Ç–∏–∂–Ω—è (approved). –°–ø–æ—á–∞—Ç–∫—É Approve next week –∞–±–æ –≤—ñ–¥–∫—Ä–∏–π approved this week.");
        return;
      }
      try{
        autoDownloadSummaryEml(targetWeekStart);
      }catch(e){
        console.error("autoDownloadSummaryEml failed:", e);
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ EML. –î–∏–≤–∏—Å—å Console.");
      }
    };
  }
  if(btnApprove){
    btnApprove.onclick = async () => {
      if(w.status !== "draft"){
        alert("–¢–∏–∂–¥–µ–Ω—å —É–∂–µ –Ω–µ –≤ —Å—Ç–∞—Ç—É—Å—ñ draft. –ü–æ–≤—Ç–æ—Ä–Ω–∏–π approve –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω.");
        return;
      }
      
      // anti-early-approve
      const emps = TEAM.filter(u=>u.role!=="manager");
      const done = emps.filter(u => !!nextWeekSubmissions[u.id]).length;
      if(done < emps.length){
        const ok = confirm(`–©–µ –Ω–µ –≤—Å—ñ –∑–∞–ø–æ–≤–Ω–∏–ª–∏ –≥—Ä–∞—Ñ—ñ–∫ (${done}/${emps.length}). –í—Å–µ –æ–¥–Ω–æ Approve?`);
        if(!ok) return;
      }

      // remote_pending -> remote
      const ws = new Date(nextWeekStart);
      for(let i=0;i<5;i++){
        const dIso = isoDate(addDays(ws,i));
        const day = w.reservations?.[dIso];
        if(!day) continue;
        for(const uid of Object.keys(day)){
          if(day[uid] === "remote_pending") day[uid] = "remote";
        }
      }

      w.status = "approved";
      w.approvedBy = me.id;
      w.approvedAt = new Date().toISOString();

      saveState();
      await saveNextWeekToDB();
      render();

      try{ autoDownloadSummaryEml(nextWeekStart); }catch(e){ console.error(e); }
    };
  }

  if(btnUnapprove){
  btnUnapprove.onclick = async () => {
  if (w.status !== "approved") {
    alert("–¢–∏–∂–¥–µ–Ω—å –Ω–µ –≤ —Å—Ç–∞—Ç—É—Å—ñ approved.");
    return;
  }
  if (!confirm("–ó–Ω—è—Ç–∏ approve —ñ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ç–∏–∂–¥–µ–Ω—å —É draft?")) return;

  // 1) –ü–∏—à–µ–º–æ –≤ Supabase —Ç—ñ–ª—å–∫–∏ meta-–ø–æ–ª—è (–Ω–µ —á—ñ–ø–∞—î–º–æ reservations/day_off)
  const { data, error } = await sb
    .from("planner_weeks")
    .update({
      status: "draft",
      approved_by: null,
      approved_at: null
    })
    .eq("week_start", nextWeekStart)
    .select("*")
    .single();

  if (error) {
    console.error("unapprove update error:", error);
    alert("Unapprove –Ω–µ –∑–±–µ—Ä—ñ–≥—Å—è –≤ Supabase: " + error.message);
    return;
  }

  // 2) –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π state –∑ —Ç–∏–º, —â–æ —Ä–µ–∞–ª—å–Ω–æ –≤ –ë–î
  state.weeks[nextWeekStart] = { ...emptyWeek(), ...rowToWeek(data) };
  localStorage.setItem(LS_KEY, JSON.stringify(state));

  render();
};
  }
    // stats refresh button (manager)
  const btnStats = document.getElementById("btnMgrStatsRefresh");
  if(btnStats){
    btnStats.onclick = async () => {
      await loadYtdStatsFromDB();
      renderManagerYtdStats();
    };
  }
}

function renderWeekCard(containerId, weekStartIso, isCurrentWeek){
  const container = document.getElementById(containerId);
  const w = getWeek(weekStartIso);
  const me = currentUser();

const editable =
  isLoggedIn() &&
  (!isCurrentWeek) &&
  (w.status !== "approved") &&
  (me.role !== "manager");


container.innerHTML = `
  <div class="weekScroller">
    <div class="grid" id="${containerId}_grid"></div>
  </div>
`;

  const grid = document.getElementById(`${containerId}_grid`);
  grid.innerHTML = "";

  const ws = new Date(weekStartIso);

  for(let i=0;i<5;i++){
    const date = addDays(ws, i);
    const dIso = isoDate(date);

    const dayBox = document.createElement("div");
    dayBox.className = "day";

    const day = w.reservations?.[dIso] || {};
    const remoteCount = Object.values(day).filter(v => v === "remote" || v === "remote_pending").length;

    if(remoteCount >= LIMIT_REMOTE_PER_DAY) dayBox.classList.add("remote-full");
    if(day[me.id] === "remote") dayBox.classList.add("is-me-remote");
    if(hasPendingInDay(weekStartIso, dIso)) dayBox.classList.add("has-pending");

    const dateLabel = date.toLocaleDateString("uk-UA", { day:"2-digit", month:"2-digit" });
    let dow = date.toLocaleDateString("uk-UA", { weekday:"long" });
    dow = dow.charAt(0).toUpperCase() + dow.slice(1);

const meUser = currentUser();
const isMgr = meUser.role === "manager";
const dayOff = isDayOff(weekStartIso, dIso);
if(dayOff) dayBox.classList.add("dayoff");
const bdays = birthdaysOnDate(dIso);
if(bdays.length) dayBox.classList.add("birthday");

dayBox.innerHTML = `
  <div class="topline">
    <div class="date">${dateLabel}</div>

    <div class="remoteMeta">
      <div class="remoteLabel">
        <b>${dow}</b>
        ${dayOff ? `<span class="pill" style="padding:2px 8px;">üéâ –í–∏—Ö—ñ–¥–Ω–∏–π</span>` : ``}
  ${(bdays && bdays.length) ? `
  <span class="pill bdayPill" style="padding:2px 8px;"
        title="–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${escapeHtml(bdays.join(", "))}">
    üéÇ –î–ù
  </span>` : ``}
      </div>

${(!isCurrentWeek && isMgr) ? `
  <button class="dayActionBtn" data-act="dayoff" data-date="${dIso}"
          title="${dayOff ? "–°–∫–∞—Å—É–≤–∞—Ç–∏ –≤–∏—Ö—ñ–¥–Ω–∏–π" : "–ó—Ä–æ–±–∏—Ç–∏ –¥–µ–Ω—å –≤–∏—Ö—ñ–¥–Ω–∏–º"}">
    ${dayOff ? "‚úñÔ∏è" : "üéâ"} <span>${dayOff ? "–°–∫–∞—Å—É–≤–∞—Ç–∏" : "–í–∏—Ö—ñ–¥–Ω–∏–π"}</span>
  </button>
` : ``}
    </div>
  </div>

  <div class="slots">${renderSlots(weekStartIso, dIso)}</div>

  ${(!isCurrentWeek) ? `<div class="hr"></div>` : ``}

  ${(!isCurrentWeek) ? `
<div class="controls">
  <button class="primary iconBtn" data-act="remote" data-date="${dIso}" title="Remote" ${(!editable ? "disabled" : "")}>
    <span class="btnIcon">üè†</span><span class="btnText">Remote</span>
  </button>

  <button class="iconBtn" data-act="office" data-date="${dIso}" title="Office" ${(!editable ? "disabled" : "")}>
    <span class="btnIcon">üè¢</span><span class="btnText">Office</span>
  </button>

  <button class="iconBtn" data-act="vacation" data-date="${dIso}" title="–í—ñ–¥–ø—É—Å—Ç–∫–∞" ${(!editable ? "disabled" : "")}>
    <span class="btnIcon">üèñÔ∏è</span><span class="btnText">–í—ñ–¥–ø—É—Å—Ç–∫–∞</span>
  </button>
</div>
  ` : ``}
`;

    grid.appendChild(dayBox);
  }

if(!isCurrentWeek){
  grid.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = (e) => {
      e.stopPropagation();

      const act = btn.dataset.act;
      const d = btn.dataset.date;

      if(act === "dayoff"){
        toggleDayOff(weekStartIso, d);
        return;
      }

      if(act === "mgrMenu"){
        const key = `${btn.dataset.date}_${btn.dataset.uid}`;
        // –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—Å—ñ —ñ–Ω—à—ñ
        grid.querySelectorAll(".mgrPopover.open").forEach(p=>p.classList.remove("open"));
        // –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π
        const pop = grid.querySelector(`.mgrPopover[data-pop="${key}"]`);
        if(pop) pop.classList.toggle("open");
        return;
      }

if(act === "mgrSet"){
  const uid = btn.dataset.uid;
  const mode = btn.dataset.mode;
  setManagerOverride(weekStartIso, d, uid, mode);

  // –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–µ–Ω—é –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É
  grid.querySelectorAll(".mgrPopover.open").forEach(p=>p.classList.remove("open"));
  return;
}
      handleSetMode(weekStartIso, d, act);
    };
  });

  // –∫–ª—ñ–∫ –ø–æ–∑–∞ —Å–ª–æ—Ç–∞–º–∏ –∑–∞–∫—Ä–∏–≤–∞—î –≤—Å—ñ –ø–æ–ø–æ–≤–µ—Ä–∏
  grid.onclick = () => {
    grid.querySelectorAll(".mgrPopover.open").forEach(p=>p.classList.remove("open"));
  };
}
}

function notifyOverridesForMe(weekStartIso){
  const me = currentUser();
  if(!me || me.role === "manager") return;

  const w = getWeek(weekStartIso);
  if(!w.overrides) return;

  const key = `rp_lastSeenOverride_${me.id}`;
  const lastSeen = Number(localStorage.getItem(key) || "0");

  const hits = [];
  for(const [dateIso, byUsers] of Object.entries(w.overrides)){
    const ov = byUsers[me.id];
    if(ov && ov.at > lastSeen){
      const byName = TEAM.find(x=>x.id===ov.by)?.name || "–∫–µ—Ä—ñ–≤–Ω–∏–∫";
      hits.push(`${dateIso}: ${formatModeUA(ov.from)} ‚Üí ${formatModeUA(ov.to)} (–∫–µ—Ä—ñ–≤–Ω–∏–∫: ${byName})`);
    }
  }

  if(hits.length){
    alert("–ö–µ—Ä—ñ–≤–Ω–∏–∫ –∑–º—ñ–Ω–∏–≤ —Ç–≤—ñ–π –≥—Ä–∞—Ñ—ñ–∫:\n\n" + hits.join("\n"));
    localStorage.setItem(key, String(Date.now()));
  }
}

function renderSlots(weekStartIso, dateIso){
  const w = getWeek(weekStartIso);
  const day = w.reservations[dateIso] || {};

  // —è–∫—â–æ –≤–∏—Ö—ñ–¥–Ω–∏–π ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ–º ‚Äú–í–∏—Ö—ñ–¥–Ω–∏–π‚Äù
  if(isDayOff(weekStartIso, dateIso)){
    return TEAM.filter(u=>u.role!=="manager").map(u=>`
      <div class="slot">
        <div class="who">
          <b>${u.name}</b>
        </div>
        <span class="tag vacation">üéâ –í–∏—Ö—ñ–¥–Ω–∏–π</span>
      </div>
    `).join("");
  }

  const meUser = currentUser();
  const isMgr = meUser.role === "manager";
  const canOverride = isMgr && canManagerOverride(weekStartIso);
  const ovDay = (w.overrides && w.overrides[dateIso]) ? w.overrides[dateIso] : {};

  return TEAM.filter(u=>u.role!=="manager").map(u=>{
    const mode = day[u.id] || "office";

    // override info (—è–∫—â–æ –±—É–≤) ‚Äî –î–õ–Ø –¶–¨–û–ì–û –Æ–ó–ï–†–ê
    const ov = ovDay[u.id];
    const ovText = ov
      ? `–ó–º—ñ–Ω–µ–Ω–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–æ–º: ${TEAM.find(x=>x.id===ov.by)?.name || "–∫–µ—Ä—ñ–≤–Ω–∏–∫"} ¬∑ ` +
        `${new Date(ov.at).toLocaleString("uk-UA")} ¬∑ ` +
        `${formatModeUA(ov.from)} ‚Üí ${formatModeUA(ov.to)}` +
        `${ov.note ? " ¬∑ " + ov.note : ""}`
      : "";

    let tagClass = "office";
    let tagText = "üè¢ Office";
    if(mode === "remote"){
      tagClass = "remote";
      tagText = "üè† Remote";
    } else if(mode === "remote_pending"){
      tagClass = "pending";
      tagText = "üü° Remote (OK?)";
    } else if(mode === "vacation"){
      tagClass = "vacation";
      tagText = "üèñÔ∏è –í—ñ–¥–ø—É—Å—Ç–∫–∞";
    }

return `
  <div class="slot">
    <div class="who">
      <b>${u.name}</b>
      ${ov ? `<div class="slotOverrideNote" title="${escapeHtml(ovText)}">‚ö†Ô∏è –ó–º—ñ–Ω–µ–Ω–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–æ–º</div>` : ``}
    </div>

<div class="slotRight">
  <span class="tag ${tagClass}">${tagText}</span>

  ${canOverride ? `
    <button class="mgrEditBtn" data-act="mgrMenu" data-date="${dateIso}" data-uid="${u.id}" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>

    <div class="mgrPopover" data-pop="${dateIso}_${u.id}">
      <button class="iconBtn" data-act="mgrSet" data-date="${dateIso}" data-uid="${u.id}" data-mode="remote" title="Remote">üè†</button>
      <button class="iconBtn" data-act="mgrSet" data-date="${dateIso}" data-uid="${u.id}" data-mode="office" title="Office">üè¢</button>
      <button class="iconBtn" data-act="mgrSet" data-date="${dateIso}" data-uid="${u.id}" data-mode="vacation" title="–í—ñ–¥–ø—É—Å—Ç–∫–∞">üèñÔ∏è</button>
    </div>
  ` : ``}
</div>
  </div>
`;
  }).join("");
}

/** =============================
 * 8) Planning logic (NEXT week only)
 * ============================= */
async function handleSetMode(weekStartIso, dateIso, desiredMode){
  if(!isLoggedIn()){
    alert("–£–≤—ñ–π–¥–∏ (Login), —â–æ–± –ø–ª–∞–Ω—É–≤–∞—Ç–∏ next week.");
    return;
  }
  const me = currentUser();
  if(me.role === "manager") return alert("–ö–µ—Ä—ñ–≤–Ω–∏–∫ –Ω–µ –±—Ä–æ–Ω—é—î. –õ–∏—à–µ approve.");
  const w = getWeek(weekStartIso);
if(w.status === "approved") return alert("–¢–∏–∂–¥–µ–Ω—å —É–∂–µ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–æ–º. –ó–º—ñ–Ω–∏ –Ω–µ–º–æ–∂–ª–∏–≤—ñ.");


 if(!w.reservations[dateIso]) w.reservations[dateIso] = {};
  const day = w.reservations[dateIso];

  // OFFICE
  if(desiredMode === "office"){
    day[me.id] = "office";
    saveState();
    return;
  }

  // VACATION
  if(desiredMode === "vacation"){
    day[me.id] = "vacation";
    saveState();
    toastForModeChange({ mode: "vacation", dateIso });
    return;
  }

  // REMOTE
  const alreadyRemote = (day[me.id] === "remote" || day[me.id] === "remote_pending");
  if(alreadyRemote) return;

  // helper: weekly 1‚Äì2, 3+ => pending
  function setRemoteWithLimit(userId){
    const current = countMyRemoteDays(weekStartIso, userId);
    const already = (day[userId] === "remote" || day[userId] === "remote_pending");
    const next = already ? current : current + 1;
    return (next <= 2) ? "remote" : "remote_pending";
  }

 // DEBUG: –ø–æ–∫–∞–∂–µ–º–æ —Ä–µ–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –¥–Ω—è
console.log("[REMOTE DEBUG]", {
  weekStartIso,
  dateIso,
  day: JSON.parse(JSON.stringify(day)),
  remoteCountComputed: countRemoteDay(weekStartIso, dateIso),
  dayValues: Object.values(day),
});

const remoteCount = countRemoteDay(weekStartIso, dateIso);

if(remoteCount >= LIMIT_REMOTE_PER_DAY){
// === DUEL LOCKS (anti-spam) ===
  const duel = getDuelState(weekStartIso, dateIso);

  // 1) –æ–¥–Ω–∞ —Å–ø—Ä–æ–±–∞ –¥—É–µ–ª—ñ –Ω–∞ –¥–µ–Ω—å –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞
  if((duel.attempts[me.id] || 0) >= 1){
    alert("–¢–∏ –≤–∂–µ –±—Ä–∞–≤(–ª–∞) —É—á–∞—Å—Ç—å —É –¥—É–µ–ª—ñ —Ü—å–æ–≥–æ –¥–Ω—è. –ü–æ–≤—Ç–æ—Ä–Ω–∞ –¥—É–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
    return;
  }

  // 2) –ª—ñ–º—ñ—Ç –¥—É–µ–ª–µ–π –Ω–∞ –¥–µ–Ω—å (—â–æ–± –Ω–µ –±—É–ª–æ –ª–∞–Ω—Ü—é–∂–∫–∞ —Ä–µ–≤–∞–Ω—à—ñ–≤)
  //    (–º–æ–∂–µ—à –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ 1, —è–∫—â–æ —Ö–æ—á–µ—à –≤–∑–∞–≥–∞–ª—ñ –º–∞–∫—Å–∏–º—É–º –æ–¥–Ω—É –¥—É–µ–ª—å –Ω–∞ –¥–µ–Ω—å)
  const MAX_DUELS_PER_DAY = 2;
  if((duel.total || 0) >= MAX_DUELS_PER_DAY){
    alert("–õ—ñ–º—ñ—Ç –¥—É–µ–ª–µ–π –Ω–∞ —Ü–µ–π –¥–µ–Ω—å –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –ó–º—ñ–Ω–∏ –º–æ–∂–ª–∏–≤—ñ –ª–∏—à–µ –≤—Ä—É—á–Ω—É (–∫–µ—Ä—ñ–≤–Ω–∏–∫–æ–º) –∞–±–æ —ñ–Ω—à–∏–º –¥–Ω–µ–º.");
    return;
  }
  // slots full => resolve conflict
  const defenderId = pickDefender(weekStartIso, dateIso);
  const defender = TEAM.find(u=>u.id===defenderId);

  if(!defender){
    alert("–ü–æ–º–∏–ª–∫–∞: –Ω–µ –∑–Ω–∞–π—à–æ–≤ defender –¥–ª—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä –∫–æ–Ω—Å–æ–ª—å.");
    console.log("[REMOTE DEBUG] defenderId", defenderId, "day", day);
    return;
  }

  let decision;
  try{
    decision = await conflictModal({ weekStartIso, dateIso, challenger: me, defender });
  }catch(e){
    alert("JS –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª–∫–∏. –î–∏–≤–∏—Å—å Console.");
    console.error("conflictModal failed:", e);
    return;
  }

  if(!decision) return;

  let ok = false;
  if(decision.type === "token"){
    ensureMonthlyTokens();
    const prev = (state.tokens && state.tokens[me.id] != null) ? state.tokens[me.id] : 0;
    if(prev <= 0) return;
    state.tokens[me.id] = Math.max(0, prev - 1);
    ok = true;
  } else {
    ok = !!decision.ok;
  }

  if(ok){
    day[defenderId] = "office";
    day[me.id] = setRemoteWithLimit(me.id);
const meta = getDayMeta(weekStartIso, dateIso);
meta.ts[me.id] = Date.now();
    bumpStats(me.id, defenderId);
  } else {
    bumpStats(defenderId, me.id);
  }
// –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏, —â–æ –ø—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –¥—É–µ–ª—å –Ω–∞ —Ü–µ–π –¥–µ–Ω—å
  duel.attempts[me.id] = (duel.attempts[me.id] || 0) + 1;
  duel.total = (duel.total || 0) + 1;

  saveState();
  toastForModeChange({ mode: day[me.id], dateIso });
  return;
}

// slots available
day[me.id] = setRemoteWithLimit(me.id);
const meta = getDayMeta(weekStartIso, dateIso);
meta.ts[me.id] = Date.now();
saveState();
toastForModeChange({ mode: day[me.id], dateIso });
return;
}

  function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function downloadText(filename, text, mime){
  const blob = new Blob([text], { type: mime || "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* === Local toast (no-AI) === */
const TOAST_JOKES = {
  remote: [
    "Remote: –≥–æ–ª–æ–≤–Ω–µ ‚Äî –Ω–µ –ø–µ—Ä–µ–ø–ª—É—Ç–∞—Ç–∏ Zoom —ñ–∑ YouTube üòÑ",
    "Remote —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ. –ö–∞–≤–∞-–±—Ä–µ–π–∫ –º–∞—î –ø—Ä–∞–≤–æ –Ω–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è ‚òï",
    "–ü—Ä–∞—Ü—é—é –≤—ñ–¥–¥–∞–ª–µ–Ω–æ: –æ—Ñ—ñ—Å —Å—å–æ–≥–æ–¥–Ω—ñ —É –º–µ–Ω–µ –≤–¥–æ–º–∞ üè†",
    "Remote day: –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑—Ä–æ—Å—Ç–∞—î –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–æ —Ç–∏—à—ñ ü§´",
    "Remote: –¥—Ä–µ—Å-–∫–æ–¥ ‚Äî —Ç—ñ–ª—å–∫–∏ –≤–µ—Ä—Ö–Ω—è —á–∞—Å—Ç–∏–Ω–∞ üß•",
    "–ü—Ä–∞—Ü—é—é –≤—ñ–¥–¥–∞–ª–µ–Ω–æ: –¥–æ—Ä–æ–≥–∞ –Ω–∞ —Ä–æ–±–æ—Ç—É –∑–∞–π–Ω—è–ª–∞ 12 —Å–µ–∫—É–Ω–¥ üö∂‚Äç‚ôÇÔ∏è",
    "Remote: KPI –¥–Ω—è ‚Äî –Ω–µ –∑–∞–±—É—Ç–∏ –∑–∞—Ä—è–¥–∫—É –Ω–æ—É—Ç–±—É–∫–∞ üîå",
    "Remote: –∫–æ–ª–∏ ‚Äò–≤–∏–π–¥—É –∑–∞ 5 —Ö–≤‚Äô –æ–∑–Ω–∞—á–∞—î ‚Äò–∑–∞ 5 —Ö–≤ –∑‚Äô—è–≤–ª—é—Å—å‚Äô ‚è±Ô∏è",
    "Remote: –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å 80%, –ø–µ—Ä–µ—Ä–≤–∞ –Ω–∞ —á–∞–π 100% üçµ"
  ],
  vacation: [
    "–í—ñ–¥–ø—É—Å—Ç–∫–∞: —Å—Ç–∞—Ç—É—Å ‚Äú–Ω–∞ –∑–≤‚Äô—è–∑–∫—É‚Äù —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π üèñÔ∏è",
    "–í—ñ–¥–ø—É—Å—Ç–∫–∞ ‚Äî —Ü–µ –∫–æ–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä –∫–∞–∂–µ ‚Äú–¥—è–∫—É—é‚Äù üôå",
    "–†–µ–∂–∏–º –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É —É–≤—ñ–º–∫–Ω–µ–Ω–æ. –†–æ–±–æ—Ç–∞ —Ö–∞–π –ø–æ—á–µ–∫–∞—î üòå",
    "–í—ñ–¥–ø—É—Å—Ç–∫–∞: —Å—å–æ–≥–æ–¥–Ω—ñ –º—ñ–π —î–¥–∏–Ω–∏–π –¥–µ–¥–ª–∞–π–Ω ‚Äî –∑–∞—Ö—ñ–¥ —Å–æ–Ω—Ü—è üåÖ",
    "–í—ñ–¥–ø—É—Å—Ç–∫–∞: –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏‚Ä¶ ‚úÖ",
    "–í—ñ–¥–ø—É—Å—Ç–∫–∞: —Ü–µ –Ω–µ –≤—Ç–µ—á–∞, —Ü–µ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è üßò"
  ]
};

function _pick(arr){
  return arr[Math.floor(Math.random() * arr.length)];
}

function _fmtDay(dateIso){
  const d = new Date(String(dateIso) + "T00:00:00");
  return d.toLocaleDateString("uk-UA", { weekday:"short", day:"2-digit", month:"2-digit" });
}

function showToast({ type="remote", title="", message="", timeout=5200 }){
  const host = document.getElementById("toastHost");
  if(!host) return;

  const el = document.createElement("div");
  el.className = `toast ${type}`;

  const icon = (type === "vacation") ? "üèñÔ∏è" : "üè†";

  el.innerHTML = `
    <div class="tIcon">${icon}</div>
    <div class="tBody">
      <div class="tTitle">${escapeHtml(title)}</div>
      <p class="tMsg">${escapeHtml(message)}</p>
    </div>
    <button class="tClose" type="button" title="–ó–∞–∫—Ä–∏—Ç–∏">‚úï</button>
  `;

  const close = () => {
    el.style.animation = "toastOut 160ms ease both";
    setTimeout(() => el.remove(), 170);
  };

  el.querySelector(".tClose")?.addEventListener("click", close);

  host.appendChild(el);

  if(timeout){
    setTimeout(close, timeout);
  }
}

function toastForModeChange({ mode, dateIso }){
  const me = currentUser();
  if(!me || me.role === "manager") return; // —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤

  if(mode !== "remote" && mode !== "remote_pending" && mode !== "vacation") return;

  const dayLabel = _fmtDay(dateIso);

  if(mode === "vacation"){
    showToast({
      type: "vacation",
      title: `–í—ñ–¥–ø—É—Å—Ç–∫–∞: ${dayLabel}`,
      message: _pick(TOAST_JOKES.vacation)
    });
    return;
  }

  // remote / remote_pending
  const pendingNote = (mode === "remote_pending") ? " (OK?)" : "";
  showToast({
    type: "remote",
    title: `Remote${pendingNote}: ${dayLabel}`,
    message: _pick(TOAST_JOKES.remote)
  });
}

  
/** =============================
 * 5.8) Manager YTD stats (Remote/Vacation)
 * ============================= */

let ytdStats = null;       // { [userId]: { remote, office, vacation } }
let ytdStatsYear = null;
let ytdStatsLoading = false;
let ytdStatsTimer = null;

function yearBounds(){
  const y = new Date().getFullYear();
  return { y, start: `${y}-01-01`, end: `${y+1}-01-01` };
}

function computeYtdStats(rows){
  const stats = {};
  TEAM.filter(isEmployee).forEach(u => stats[u.id] = { remote:0, office:0, vacation:0 });

  for(const row of (rows || [])){
    const res = row.reservations || {};
    const off = row.day_off || {};

    // –≤–∞–∂–ª–∏–≤–æ: week_start —è–∫ –ª–æ–∫–∞–ª—å–Ω–∞ –¥–∞—Ç–∞ –±–µ–∑ –∑—Å—É–≤—ñ–≤
    const ws = new Date(String(row.week_start) + "T00:00:00");

    for(let i=0;i<5;i++){
      const dIso = isoDate(addDays(ws, i));

      // —è–∫—â–æ –≤–∏—Ö—ñ–¥–Ω–∏–π ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ (—É –≤—Å—ñ—Ö)
      if(off && off[dIso]) continue;

      const day = res[dIso] || {};

      // –†–ê–•–£–Ñ–ú–û –î–õ–Ø –ö–û–ñ–ù–û–ì–û –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –∑–∞–ø–∏—Å—É –≤ JSON –Ω–µ–º–∞ (=> office)
      for(const u of TEAM.filter(isEmployee)){
        const mode = day?.[u.id] || "office";

        if(mode === "remote" || mode === "remote_pending"){
          stats[u.id].remote++;
        }else if(mode === "vacation"){
          stats[u.id].vacation++;
        }else{
          stats[u.id].office++;
        }
      }
    }
  }

  return stats;
}

async function loadYtdStatsFromDB(){
  const me = currentUser();
  if(!isLoggedIn() || !me || me.role !== "manager") return;

  if(ytdStatsLoading) return;
  ytdStatsLoading = true;

  const hint = document.getElementById("mgrStatsHint");
  if(hint) hint.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é‚Ä¶";

  try{
    const { y, start, end } = yearBounds();

    const { data, error } = await sb
      .from("planner_weeks")
      .select("week_start,reservations,day_off")
      .gte("week_start", start)
      .lt("week_start", end);

    if(error){
      console.warn("loadYtdStatsFromDB error:", error);
      ytdStats = null;
      ytdStatsYear = y;
      return;
    }

    ytdStatsYear = y;
    ytdStats = computeYtdStats(data || []);
  } finally {
    ytdStatsLoading = false;
    if(hint) hint.textContent = ytdStatsYear ? `–†—ñ–∫: ${ytdStatsYear}` : "";
  }
}

function queueYtdStatsRefresh(){
  const me = currentUser();
  if(!me || me.role !== "manager") return;

  clearTimeout(ytdStatsTimer);
  ytdStatsTimer = setTimeout(async () => {
    await loadYtdStatsFromDB();
    renderManagerYtdStats();
  }, 350);
}

function renderManagerYtdStats(){
  const card = document.getElementById("mgrStatsCard");
  const body = document.getElementById("mgrStatsBody");
  if(!card || !body) return;

  const me = currentUser();
  if(!isLoggedIn() || !me || me.role !== "manager"){
    card.style.display = "none";
    return;
  }

  card.style.display = "block";
  setMgrStatsOpen(getMgrStatsOpen());

  if(!ytdStats){
    body.innerHTML = `<div class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö (–∞–±–æ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ planner_weeks). –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–û–Ω–æ–≤–∏—Ç–∏‚Äù.</div>`;
    return;
  }

  const emps = TEAM.filter(isEmployee);

  // max for scaling
let maxRemote = 0, maxOffice = 0, maxVacation = 0;

for(const u of emps){
  const s = ytdStats[u.id] || { remote:0, office:0, vacation:0 };
  maxRemote = Math.max(maxRemote, s.remote);
  maxOffice = Math.max(maxOffice, s.office);
  maxVacation = Math.max(maxVacation, s.vacation);
}

  // sort: remote desc, then vacation desc
const rows = emps
  .map(u => ({ u, s: ytdStats[u.id] || { remote:0, office:0, vacation:0 } }))
  .sort((a,b) =>
    (b.s.remote - a.s.remote) ||
    (b.s.office - a.s.office) ||
    (b.s.vacation - a.s.vacation) ||
    String(a.u.name).localeCompare(String(b.u.name),"uk")
  );

  body.innerHTML = rows.map(({u, s}) => {
const rPct = maxRemote ? Math.round((s.remote / maxRemote) * 100) : 0;
const oPct = maxOffice ? Math.round((s.office / maxOffice) * 100) : 0;
const vPct = maxVacation ? Math.round((s.vacation / maxVacation) * 100) : 0;

// remote/office: —á–∏—Å–ª–æ–≤–µ + % remote (–±–µ–∑ vacation)
const denom = s.remote + s.office;
const pctR = denom ? Math.round((s.remote / denom) * 100) : 0;
const roText = `${s.remote}/${s.office} ¬∑ ${pctR}%`;

return `
  <div class="statRow">
    <div class="statName" title="${escapeHtml(u.name)}">${escapeHtml(u.name)}</div>

    <div class="statBars">
      <div class="barTrack" title="Remote: ${s.remote}">
        <div class="barFill remote" style="width:${rPct}%"></div>
      </div>
      <div class="barTrack" title="Office: ${s.office}">
        <div class="barFill office" style="width:${oPct}%"></div>
      </div>
      <div class="barTrack" title="–í—ñ–¥–ø—É—Å—Ç–∫–∞: ${s.vacation}">
        <div class="barFill vacation" style="width:${vPct}%"></div>
      </div>
    </div>

    <div class="statNum">${s.remote}<span>R</span></div>
    <div class="statNum">${s.office}<span>O</span></div>
    <div class="statNum">${s.vacation}<span>V</span></div>
    <div class="statNum" title="Remote/Office: ${s.remote}/${s.office} (${pctR}%)">${roText}</div>
  </div>
`;
  }).join("");
}

/** =============================
 * 10) SUMMARY EMAIL (EML) ‚Äî for manager approve
 * ============================= */

function b64utf8(str){
  const bytes = new TextEncoder().encode(str);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}

function rfc2047(str){
  // –∫–æ–¥—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –Ω–µ-ASCII
  return /[^\x20-\x7E]/.test(str) ? `=?UTF-8?B?${b64utf8(str)}?=` : str;
}

function qpEncode(str){
  // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π quoted-printable –¥–ª—è UTF-8 html
  const utf8 = new TextEncoder().encode(str);
  let out = "";
  let lineLen = 0;

  for(const b of utf8){
    let chunk;
    // –¥–æ–∑–≤–æ–ª–µ–Ω—ñ "–ø—Ä–æ—Å—Çi" ASCII
    if((b >= 33 && b <= 60) || (b >= 62 && b <= 126) || b === 9 || b === 32){
      chunk = String.fromCharCode(b);
      // –ø—Ä–æ–±—ñ–ª –Ω–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ —Ä—è–¥–∫–∞ —Ç—Ä–µ–±–∞ –∫–æ–¥—É–≤–∞—Ç–∏
      if(b === 32) chunk = " ";
    } else if(b === 13){
      chunk = ""; // CR –ø—Ä–æ–ø—É—Å—Ç–∏–º–æ, LF –æ–±—Ä–æ–±–∏–º–æ
    } else if(b === 10){
      out += "\r\n";
      lineLen = 0;
      continue;
    } else {
      chunk = "=" + b.toString(16).toUpperCase().padStart(2,"0");
    }

    // soft wrap ~76
    if(lineLen + chunk.length > 74){
      out += "=\r\n";
      lineLen = 0;
    }

    out += chunk;
    lineLen += chunk.length;
  }
  return out;
}

function buildSummaryEMLForWeek(weekStartIso, senderName, senderEmail, recipients, subject, htmlBody){
  const lines = [];

  // recipients: –º–∞—Å–∏–≤ —Å—Ç—Ä–æ–∫ email, –∞–±–æ –º–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ {name,email}
  const toHeader = (recipients || []).map(r => {
    if(typeof r === "string") return r;
    return `${rfc2047(r.name)} <${r.email}>`;
  }).join(", ");

  lines.push(`From: ${rfc2047(senderName)} <${senderEmail}>`);
  lines.push(`To: ${toHeader}`);
  lines.push(`Subject: ${rfc2047(subject)}`);
  lines.push(`Date: ${new Date().toUTCString()}`);
  lines.push(`MIME-Version: 1.0`);
  lines.push(`Content-Type: text/html; charset="UTF-8"`);
  lines.push(`Content-Transfer-Encoding: quoted-printable`);
  lines.push(""); // –ø—É—Å—Ç–∏–π —Ä—è–¥–æ–∫ –º—ñ–∂ headers —ñ body
  lines.push(qpEncode(htmlBody));

  return lines.join("\r\n");
}
  
/**
 * HTML summary –ë–ï–ó emoji/—ñ–∫–æ–Ω–æ–∫ (–±–æ Outlook –ø–æ–∫–∞–∑—É—î ??).
 * –¢—É—Ç ‚ÄúRemote/Office/–í—ñ–¥–ø—É—Å—Ç–∫–∞/–í–∏—Ö—ñ–¥–Ω–∏–π/OK?‚Äù ‚Äî —Ç—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç.
 */
function buildSummaryHtmlTable_NoIcons(weekStartIso){
  const w = getWeek(weekStartIso);
  const ws = new Date(weekStartIso);

  const dates = [];
  for(let i=0;i<5;i++){
    const dIso = isoDate(addDays(ws,i));
    const d = addDays(ws,i);
    const ddmm = d.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit"});
    let wd = d.toLocaleDateString("uk-UA",{weekday:"short"});
    dates.push({ dIso, label: `${wd} ${ddmm}` });
  }

  const pill = (text, bg, bd, color) => `
    <span style="display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid ${bd};
      background:${bg};color:${color};font-weight:700;font-size:12px;white-space:nowrap;">
      ${text}
    </span>`;

  const STATUS = {
    remote:   () => pill("Remote", "#ECFEFF", "#22D3EE", "#0369A1"),
    office:   () => pill("Office", "#F1F5F9", "#CBD5E1", "#334155"),
    vacation: () => pill("–í—ñ–¥–ø—É—Å—Ç–∫–∞", "#EEF2FF", "#A5B4FC", "#3730A3"),
    dayoff:   () => pill("–í–∏—Ö—ñ–¥–Ω–∏–π", "#FEF9C3", "#FACC15", "#854D0E"),
    pending:  () => pill("Remote (OK?)", "#FFF7ED", "#FDBA74", "#9A3412"),
  };

  const employees = TEAM.filter(u=>u.role!=="manager");

  const head = `
    <tr>
      <th style="padding:10px;border:1px solid #E5E7EB;background:#F8FAFC;text-align:left;font-size:12px;">–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫</th>
      ${dates.map(x=>`<th style="padding:10px;border:1px solid #E5E7EB;background:#F8FAFC;text-align:center;font-size:12px;">${x.label}</th>`).join("")}
    </tr>
  `;

  const rows = employees.map(u=>{
    const tds = dates.map(x=>{
      const dayOff = !!(w.dayOff && w.dayOff[x.dIso]);
      if(dayOff) return `<td style="padding:10px;border:1px solid #E5E7EB;text-align:center;">${STATUS.dayoff()}</td>`;

      const mode = (w.reservations?.[x.dIso]?.[u.id]) || "office";
      const cell =
        mode==="remote" ? STATUS.remote() :
        mode==="vacation" ? STATUS.vacation() :
        mode==="remote_pending" ? STATUS.pending() :
        STATUS.office();

    const ov = w.overrides?.[x.dIso]?.[u.id];   // –º–æ–∂–µ –±—É—Ç–∏ true –∞–±–æ –æ–±'—î–∫—Ç
    const changedMark = ov
      ? `<div style="margin-top:6px;font-size:11px;font-weight:700;color:#8a2c2c;line-height:1.1;">
           –ó–º—ñ–Ω–µ–Ω–æ –∫–µ—Ä—ñ–≤–Ω–∏–∫–æ–º
         </div>`
      : "";

    return `<td style="padding:10px;border:1px solid #E5E7EB;text-align:center;">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
                ${cell}
                ${changedMark}
              </div>
            </td>`;
  }).join("");

  return `<tr>
    <td style="padding:10px;border:1px solid #E5E7EB;font-weight:700;white-space:nowrap;">${u.name}</td>
    ${tds}
  </tr>`;
}).join("");

  const range = `${dates[0].label} ‚Äì ${dates[4].label}`;
  const approver = (w.approvedBy ? (PROFILE_BY_ID[w.approvedBy] || null) : null);
  const approvedAt = w.approvedAt ? new Date(w.approvedAt) : null;
  const approvedLine = (approver && approvedAt)
    ? `–ü–æ–≥–æ–¥–∂–µ–Ω–æ: <b>${approver.full_name || approver.email || "–∫–µ—Ä—ñ–≤–Ω–∏–∫"}</b>, ${approvedAt.toLocaleString("uk-UA", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" })}`
    : "";

  return `
    <div style="font-family:Segoe UI, Arial, sans-serif;color:#0F172A;">
      <div style="font-size:16px;font-weight:800;margin:0 0 6px;">–ì—Ä–∞—Ñ—ñ–∫ office/remote: ${range}</div>
      <div style="color:#64748B;font-size:13px;margin:0 0 10px;">–ü—ñ–¥—Å—É–º–æ–∫ —Ç–∏–∂–Ω—è –ø—ñ—Å–ª—è approve.</div>
      ${approvedLine ? `<div style="color:#334155;font-size:13px;margin:0 0 14px;">${approvedLine}</div>` : ``}

      <table role="presentation" cellpadding="0" cellspacing="0" style="border-collapse:collapse;width:100%;max-width:760px;">
        <thead>${head}</thead>
        <tbody>${rows}</tbody>
      </table>

      <div style="margin-top:10px;color:#94A3B8;font-size:12px;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π summary.</div>
    </div>
  `;
}
  
function autoDownloadSummaryEml(weekStartIso){
  const w = getWeek(weekStartIso);

  // sender = –∫–µ—Ä—ñ–≤–Ω–∏–∫ (approvedBy) –∞–±–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä
  const mgrProfile = w.approvedBy ? (PROFILE_BY_ID[w.approvedBy] || null) : null;
  const mgr = TEAM.find(u => u.role==="manager");
  const senderName  = mgrProfile?.full_name || mgrProfile?.email || mgr?.name || "Manager";
  const senderEmail = mgrProfile?.email || EMAILS[mgr?.id] || "manager@domain.ua";

  // recipients = –≤—Å—ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏ (employees)
  const recipients = TEAM
    .filter(u => u.role !== "manager")
    .map(u => ({ name: u.name, email: EMAILS[u.id] }))
    .filter(x => !!x.email);

  // subject + htmlBody
  const ws = new Date(weekStartIso);
  const range = `${ws.toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit"})} ‚Äì ${addDays(ws,4).toLocaleDateString("uk-UA",{day:"2-digit",month:"2-digit"})}`;
  const subject = `–ì—Ä–∞—Ñ—ñ–∫ office/remote: ${range}`;

  const htmlBody = buildSummaryHtmlTable_NoIcons(weekStartIso);

  const eml = buildSummaryEMLForWeek(
    weekStartIso,
    senderName,
    senderEmail,
    recipients,
    subject,
    htmlBody
  );

  downloadText(`summary_${weekStartIso}.eml`, eml, "message/rfc822");
}


/** =============================
 * 5.9) Realtime (Postgres Changes) ‚Äî sync nextWeek in all browsers
 *  - listens only for planner_weeks where week_start == nextWeekStart
 *  - applies remote updates to local state WITHOUT triggering saveState()
 * ============================= */

let rtChannel = null;
let rtChannelThis = null; // current week mirror
  let rtChannelSubs = null;

let rtApplying = false;


function startRealtimeForThisWeek(){
  if(rtChannelThis) return;

  rtChannelThis = sb
    .channel(`planner_weeks_this_${thisWeekStart}`)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'planner_weeks',
      filter: `week_start=eq.${thisWeekStart}`
    }, (payload) => {
      try{
        const row = payload.new || payload.old;
        if(!row) return;

        state.weeks[thisWeekStart] = { ...emptyWeek(), ...rowToWeek(row) };
        localStorage.setItem(LS_KEY, JSON.stringify(state));

        if(!rtApplying) render();
        queueYtdStatsRefresh();
      }catch(e){
        console.error("RT thisWeek apply failed:", e);
      }
    })
    .subscribe();
}
  
function startRealtimeForSubmissions(){
  if(rtChannelSubs) return;
  if(!isLoggedIn()) return;

  rtChannelSubs = sb
    .channel(`planner_submissions:${nextWeekStart}`)
    .on("postgres_changes", {
      event: "*",
      schema: "public",
      table: "planner_submissions",
      filter: `week_start=eq.${nextWeekStart}`,
    }, async () => {
      // –Ω–∞–π–Ω–∞–¥—ñ–π–Ω—ñ—à–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç–∏
      await loadNextWeekSubmissions();
      render();
    })
    .subscribe();
}

  
function stopRealtime(){
  try{
    if(rtChannel){
      sb.removeChannel(rtChannel);
      rtChannel = null;
    }
  }catch(e){
    console.warn("stopRealtime(next) error:", e);
  }

  try{
    if(rtChannelThis){
      sb.removeChannel(rtChannelThis);
      rtChannelThis = null;
    }
  }catch(e){
    console.warn("stopRealtime(this) error:", e);
  }
   
  try{
    if(rtChannelSubs){
      sb.removeChannel(rtChannelSubs);
      rtChannelSubs = null;
    }
  }catch(e){
    console.warn("stopRealtime(subs) error:", e);
  }

}

function startRealtimeForNextWeek(){
  if(rtChannel) return;               // already running
  if(!isLoggedIn()) return;           // only for authed users

  rtChannel = sb
    .channel(`planner_weeks:${nextWeekStart}`)
    .on("postgres_changes", {
        event: "*",
        schema: "public",
        table: "planner_weeks",
        filter: `week_start=eq.${nextWeekStart}`,
      }, (payload) => {
        // payload.eventType: INSERT | UPDATE | DELETE
        // payload.new / payload.old: row
        try{
          rtApplying = true;

          if(payload.eventType === "DELETE"){
            // record removed ‚Äî reset local week
            const dbWeek = emptyWeek();
            nextWeekDbUpdatedAt = null;
            nextWeekDbSnapshot = deepCopy(dbWeek);

            // if we have local unsaved edits, keep them visible
            const baseSnap = nextWeekDbSnapshot || dbWeek;
            const localWeek = state.weeks[nextWeekStart] || emptyWeek();
            const localOps = computeWeekOps(baseSnap, localWeek);

            const viewWeek = deepCopy(dbWeek);
            applyWeekOps(viewWeek, localOps);

            state.weeks[nextWeekStart] = viewWeek;
          }else{
            const row = payload.new;
            if(row){
              // keep last DB updated_at for optimistic locking
              nextWeekDbUpdatedAt = row.updated_at || nextWeekDbUpdatedAt;

              const dbWeek = { ...emptyWeek(), ...rowToWeek(row) };

              // if we have local unsaved edits, reapply them on top of the incoming DB state
              const baseSnap = nextWeekDbSnapshot || dbWeek;
              const localWeek = state.weeks[nextWeekStart] || emptyWeek();
              const localOps = computeWeekOps(baseSnap, localWeek);

              nextWeekDbSnapshot = deepCopy(dbWeek);

              const viewWeek = deepCopy(dbWeek);
              applyWeekOps(viewWeek, localOps);

              state.weeks[nextWeekStart] = viewWeek;
            }
          }

          // write only to localStorage (NO saveState -> no DB write)
          localStorage.setItem(LS_KEY, JSON.stringify(state));
queueYtdStatsRefresh();
          // refresh UI (so everybody sees the change)
          render();
        }catch(e){
          console.error("realtime apply error:", e, payload);
        }finally{
          rtApplying = false;
        }
      })
    .subscribe((status) => {
      console.log("[realtime planner_weeks]", status);
    });
}

  // === Manager stats collapse toggle ===
const LS_MGR_STATS_OPEN = "rp_mgrStatsOpen";

function setMgrStatsOpen(open){
  const content = document.getElementById("mgrStatsContent");
  const btn = document.getElementById("btnMgrStatsToggle");
  if(content) content.style.display = open ? "block" : "none";
  if(btn) btn.textContent = open ? "–ó–≥–æ—Ä–Ω—É—Ç–∏" : "–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏";
  localStorage.setItem(LS_MGR_STATS_OPEN, open ? "1" : "0");
}

function getMgrStatsOpen(){
  // –¥–µ—Ñ–æ–ª—Ç: –∑–≥–æ—Ä–Ω—É—Ç–æ
  return localStorage.getItem(LS_MGR_STATS_OPEN) === "1";
}

// –Ω–∞–≤—ñ—à—É—î–º–æ –æ–¥–∏–Ω —Ä–∞–∑ (–∫–Ω–æ–ø–∫–∞ —î –≤ DOM –∑ –ø–æ—á–∞—Ç–∫—É)
(function initMgrStatsToggle(){
  const btn = document.getElementById("btnMgrStatsToggle");
  if(!btn) return;

  // —Å—Ç–∞—Ä—Ç–æ–≤–∏–π —Å—Ç–∞–Ω
  setMgrStatsOpen(getMgrStatsOpen());

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    const open = !getMgrStatsOpen();
    setMgrStatsOpen(open);
  });
})();

/** =============================
 * 6) Auth init (single entry point)
 *  - init session
 *  - on login: load profiles -> build TEAM -> init state/week -> load DB + realtime
 *  - on logout: stop realtime + clear roster UI
 * ============================= */

async function initAfterLogin(){
  // 1) profiles -> TEAM
  await refreshProfilesCache();
  buildTeamFromProfiles();
  buildBirthdaysFromProfiles();
  buildLastNameIndexFromProfiles();

  // 2) UI for "me" (hidden selector + label)
  initRosterUI();
  setMeToLoggedInUser();

  // 3) state + migration
  if(!state) state = loadState();

  // 4) week keys + initial weeks
  initWeekKeys();

  // 5) DB week + realtime
  await loadThisWeekFromDB();
  await loadNextWeekFromDB();
  await loadNextWeekSubmissions();

  startRealtimeForNextWeek();
  startRealtimeForThisWeek();
  startRealtimeForSubmissions();
  // manager YTD stats
  const me = currentUser();
  if(me?.role === "manager"){
    await loadYtdStatsFromDB();
    renderManagerYtdStats();
  }
}

function clearAppOnLogout(){
  stopRealtime();
  TEAM = [];
  EMAILS = {};

  const meName = document.getElementById("meName");
  if(meName){
    meName.textContent = "";
    meName.style.display = "none";
  }
}

async function applyAuthSession(session){
  // –Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ URL —â–µ –º—ñ—Å—Ç–∏—Ç—å type=recovery
  if(detectRecoveryFromUrl()) isRecoveryMode = true;

  currentSession = session || null;

  if(isRecoveryMode){
    setAuthUI(currentSession, { recovery: true });
    showResetCard(true);
    clearAppOnLogout();
    return; // –ù–ï render/init weeks
  }

  setAuthUI(currentSession);

  if(isLoggedIn()){
    await initAfterLogin();
  }else{
    clearAppOnLogout();
  }

  render();
}

// –ù–∞–¥—ñ–π–Ω–∏–π —Å—Ç–∞—Ä—Ç –ø—ñ—Å–ª—è refresh:
// - —á–µ–∫–∞—î–º–æ INITIAL_SESSION (–∫–æ–ª–∏ Supabase –≤—ñ–¥–Ω–æ–≤–∏—Ç—å —Å–µ—Å—ñ—é –∑—ñ —Å—Ö–æ–≤–∏—â–∞)
// - fallback: getSession()
let __bootApplied = false;

async function boot(){
  let session = null;

  try{
    session = await Promise.race([
      __initialSessionPromise,
      (async () => {
        const { data: { session }, error } = await sb.auth.getSession();
        if(error) console.error("getSession error:", error);
        return session || null;
      })()
    ]);
  }catch(e){
    console.error("boot session race error:", e);
    const { data: { session } } = await sb.auth.getSession();
    session = session || null;
  }

  __bootApplied = true;
  await applyAuthSession(session);
}

// –æ–¥–∏–Ω listener –Ω–∞ –∑–º—ñ–Ω—É auth-—Å—Ç–∞–Ω—É (–ø—ñ—Å–ª—è boot)
sb.auth.onAuthStateChange(async (event, session) => {
  // INITIAL_SESSION –º–∏ –≤–∂–µ –æ–±—Ä–æ–±–ª—è—î–º–æ –≤ boot() ‚Äî —â–æ–± –Ω–µ —Ä–æ–±–∏—Ç–∏ initAfterLogin() –¥–≤—ñ—á—ñ
  if(event === "INITIAL_SESSION" && __bootApplied) return;

  // —è–∫—â–æ boot —â–µ –Ω–µ –≤—Å—Ç–∏–≥ ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏–º–æ, boot –ø—ñ–¥—Ö–æ–ø–∏—Ç—å
  if(!__bootApplied) return;

  await applyAuthSession(session);
});
// init
boot();
</script>
</body>

</html>
